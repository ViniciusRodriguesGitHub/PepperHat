<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pepper Hat - Kanban Colaborativo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React/ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- √çcones -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithPopup, 
            GoogleAuthProvider,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            setPersistence, 
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO DO FIREBASE (PEPPERHAT APPS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBru9u7vjuX1Gp2WpT8bikvh580uhruXYw",
            authDomain: "pepperhatapps.firebaseapp.com",
            projectId: "pepperhatapps",
            storageBucket: "pepperhatapps.firebasestorage.app",
            messagingSenderId: "306221893302",
            appId: "1:306221893302:web:63c97387bf48950cd88817"
        };
        // -------------------------------------------------

        const appId = 'pepperhatapps'; // Identificador do app

        if (firebaseConfig.projectId) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            window.googleProvider = new GoogleAuthProvider();

            setPersistence(window.auth, browserLocalPersistence).catch(console.warn);

            window.doc = doc;
            window.setDoc = setDoc;
            window.onSnapshot = onSnapshot;
            window.signInWithPopup = signInWithPopup;
            window.signInAnonymously = signInAnonymously;
            window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
            window.signInWithEmailAndPassword = signInWithEmailAndPassword;
            window.signOut = signOut;

            onAuthStateChanged(window.auth, (user) => {
                window.dispatchEvent(new CustomEvent('auth-change', { detail: user }));
            });
        }
    </script>
    
    <style>
      html, body { height: 100%; }
      .text-xxs { font-size: 0.65rem; }
      .pulsing-alert { animation: pulse 1.5s infinite; }
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
      }
      .pulsing-green { animation: pulse-green 1s infinite cubic-bezier(0.66, 0, 0.33, 1); }
      @keyframes pulse-green {
        0%, 100% { background-color: var(--card-bg-color, white); }
        50% { background-color: var(--pulse-green-color, #d4edda); }
      }
      .fade-in { animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
  </head>
  <body class="min-h-screen bg-stone-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState, useRef, useCallback } = React;

      // --- CONSTANTES ---
      const colorPalette = { lightGreen: '#d4edda', lightBlue: '#d1ecf1', lilac: '#dbcff8', yellow: '#fff3cd', pink: '#f8c0c8', lightGrey: '#e9ecef', offWhite: '#f8f9fa' };
      const softPastelColors = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#E0BBE4', '#FFD7A3', '#CCE2CB', '#F0EAD6', '#D4EEFF', '#F5DEB3'];

      const getBackgroundColor = (columnId) => {
        const mapping = { 'primeiro-contato': colorPalette.lightGreen, 'demonstrou-interesse': colorPalette.lightBlue, 'contato-pessoal': colorPalette.lilac, 'fez-orcamento': colorPalette.yellow, 'contratou': colorPalette.pink, 'arquivados': colorPalette.offWhite, 'descartados': colorPalette.lightGrey };
        return mapping[columnId] || colorPalette.lightBlue;
      };

      const defaultBoardState = {
        columns: {},
        columnOrder: [],
        columnWidths: {},
        categories: [],
        teamMembers: [],
        activityOptions: ['Interna', 'Externa', 'Digital'],
        durationOptions: ['Minutos', 'Horas', 'Dia', 'Dias'],
        columnsLocked: false,
      };

      const columnTemplates = {
        'produtividade': {
          name: 'Produtividade (Tarefas)',
          icon: '‚ö°',
          description: 'Foco: fluxo simples de execu√ß√£o.',
          columns: [
            { id: 'a-fazer', title: 'A Fazer', color: '#d1ecf1' },
            { id: 'fazendo', title: 'Fazendo', color: '#fff3cd' },
            { id: 'pendente', title: 'Pendente', color: '#f8c0c8' },
            { id: 'concluido', title: 'Conclu√≠do', color: '#cce2cb' },
          ]
        },
        'vendas': {
          name: 'Vendas (CRM)',
          icon: 'üí∞',
          description: 'Foco: simplificar a jornada at√© o fecho.',
          columns: [
            { id: 'novos', title: 'Novos', color: '#d1ecf1' },
            { id: 'contato', title: 'Contato', color: '#d4edda' },
            { id: 'proposta', title: 'Proposta', color: '#fff3cd' },
            { id: 'fechado', title: 'Fechado', color: '#cce2cb' },
            { id: 'perdido', title: 'Perdido', color: '#e9ecef' },
          ]
        },
        'conteudo': {
          name: 'Marketing (Conte√∫do)',
          icon: 'üìù',
          description: 'Foco: da ideia √† publica√ß√£o.',
          columns: [
            { id: 'ideias', title: 'Ideias', color: '#e0bbe4' },
            { id: 'producao', title: 'Produ√ß√£o', color: '#d4edda' },
            { id: 'revisao', title: 'Revis√£o', color: '#fff3cd' },
            { id: 'publicado', title: 'Publicado', color: '#cce2cb' },
          ]
        },
        'recrutamento': {
          name: 'Recrutamento (RH)',
          icon: 'üë•',
          description: 'Foco: sele√ß√£o r√°pida de candidatos.',
          columns: [
            { id: 'inscritos', title: 'Inscritos', color: '#d1ecf1' },
            { id: 'entrevista', title: 'Entrevista', color: '#fff3cd' },
            { id: 'proposta', title: 'Proposta', color: '#f8c0c8' },
            { id: 'contratado', title: 'Contratado', color: '#cce2cb' },
          ]
        },
        'desenvolvimento': {
          name: 'Desenvolvimento (TI)',
          icon: 'üíª',
          description: 'Foco: entrega de funcionalidades.',
          columns: [
            { id: 'backlog', title: 'Backlog', color: '#e9ecef' },
            { id: 'codando', title: 'Codando', color: '#d4edda' },
            { id: 'testes', title: 'Testes', color: '#fff3cd' },
            { id: 'pronto', title: 'Pronto', color: '#cce2cb' },
          ]
        },
        'estudos': {
          name: 'Estudos',
          icon: 'üìö',
          description: 'Foco: organizar o aprendizado.',
          columns: [
            { id: 'fila', title: 'Fila', color: '#e0bbe4' },
            { id: 'estudando', title: 'Estudando', color: '#d4edda' },
            { id: 'pratica', title: 'Pr√°tica', color: '#fff3cd' },
            { id: 'finalizado', title: 'Finalizado', color: '#cce2cb' },
          ]
        },
      };

      function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
      function getCurrentDateString() { const t = new Date(); return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; }
      function getCurrentTimeString() { const n = new Date(); return `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }
      function useDebounce(callback, delay) {
        const timeoutRef = useRef();
        return useCallback((...args) => {
            clearTimeout(timeoutRef.current);
            timeoutRef.current = setTimeout(() => callback(...args), delay);
        }, [callback, delay]);
      }

      // --- APP CORE ---
      function App() {
        const [user, setUser] = useState(null);
        const [projectId, setProjectId] = useState(localStorage.getItem('pepperhat_last_project') || null);
        const [storageMode, setStorageMode] = useState(localStorage.getItem('pepperhat_storage_mode') || 'private');
        const [loading, setLoading] = useState(true);

        useEffect(() => {
            const handler = (e) => { setUser(e.detail); setLoading(false); };
            window.addEventListener('auth-change', handler);
            if(window.auth?.currentUser) { setUser(window.auth.currentUser); setLoading(false); }
            else setTimeout(() => setLoading(false), 1500);
            return () => window.removeEventListener('auth-change', handler);
        }, []);

        const handleSwitchMode = (mode) => { setStorageMode(mode); localStorage.setItem('pepperhat_storage_mode', mode); };
        const handleLogout = () => { window.auth.signOut(); setProjectId(null); setUser(null); };

        if(loading) return <div className="flex items-center justify-center h-screen bg-purple-50"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-700"></div></div>;
        if(!user) return <AuthHome />;
        if(!projectId) return <ProjectSelection user={user} onSelectProject={id => {setProjectId(id); localStorage.setItem('pepperhat_last_project', id);}} onLogout={handleLogout} />;

        return <KanbanBoard user={user} projectId={projectId} storageMode={storageMode} onSwitchMode={handleSwitchMode} onBack={() => setProjectId(null)} />;
      }

      // --- AUTH & PROJECT SELECTION ---
      function AuthHome() {
          const [email, setEmail] = useState(''); const [pass, setPass] = useState(''); const [err, setErr] = useState('');
          const doLogin = async (isRegister) => {
              setErr('');
              try {
                  if(isRegister) await window.createUserWithEmailAndPassword(window.auth, email, pass);
                  else await window.signInWithEmailAndPassword(window.auth, email, pass);
              } catch(e) { 
                   let msg = "Erro de autentica√ß√£o.";
                   if (e.code === 'auth/operation-not-allowed') msg = "‚ö†Ô∏è Email/Senha n√£o ativado no Console do Firebase.";
                   else if (e.code === 'auth/invalid-credential') msg = "Email ou senha inv√°lidos.";
                   setErr(msg); 
              }
          };

          const handleGoogleLogin = async () => {
            setErr('');
            try {
                await window.signInWithPopup(window.auth, window.googleProvider);
            } catch (err) {
                console.error("Google Auth Error:", err);
                if (err.code === 'auth/unauthorized-domain') {
                    setErr("‚ö†Ô∏è Dom√≠nio n√£o autorizado no Firebase. (Adicione este dom√≠nio em Authentication > Settings > Authorized domains)");
                } else if (err.code === 'auth/popup-closed-by-user') {
                    setErr("Login cancelado.");
                } else {
                    setErr("Erro ao conectar com Google: " + err.message);
                }
            }
          };

          const handleAnonymousLogin = async () => {
            setErr('');
            try {
                await window.signInAnonymously(window.auth);
            } catch (err) {
                console.error("Anon Auth Error:", err);
                if (err.code === 'auth/admin-restricted-operation') {
                     setErr("‚ö†Ô∏è O login an√¥nimo n√£o est√° ativado no Console do Firebase. (Ative em Authentication > Sign-in method > Anonymous)");
                } else {
                     setErr("Erro ao entrar como convidado: " + err.message);
                }
            }
          };

          return (
              <div className="flex items-center justify-center h-screen bg-gray-50">
                  <div className="bg-white p-8 rounded shadow-lg w-96 text-center">
                      <h1 className="text-3xl font-bold mb-4">Pepper Hat üå∂Ô∏è</h1>
                      {err && <div className="bg-red-100 text-red-600 text-xs p-2 mb-2 rounded font-semibold text-left">{err}</div>}
                      
                      <button 
                        onClick={handleGoogleLogin} 
                        className="w-full flex items-center justify-center gap-3 bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 hover:shadow transition-all mb-3"
                      >
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" alt="G" />
                        Continuar com Google
                      </button>

                      <button onClick={handleAnonymousLogin} className="w-full bg-gray-100 text-gray-600 p-2 rounded mb-4 hover:bg-gray-200 text-sm font-semibold">Entrar como Convidado</button>
                      
                      <div className="relative flex py-2 items-center">
                        <div className="flex-grow border-t border-gray-300"></div>
                        <span className="flex-shrink-0 mx-2 text-gray-400 text-xs">ou Email</span>
                        <div className="flex-grow border-t border-gray-300"></div>
                      </div>

                      <input className="w-full border p-2 mb-2 rounded" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} />
                      <input className="w-full border p-2 mb-4 rounded" type="password" placeholder="Senha" value={pass} onChange={e=>setPass(e.target.value)} />
                      <div className="flex gap-2">
                          <button onClick={()=>doLogin(false)} className="flex-1 bg-purple-600 text-white p-2 rounded hover:bg-purple-700 font-bold">Entrar</button>
                          <button onClick={()=>doLogin(true)} className="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700 font-bold">Cadastrar</button>
                      </div>
                  </div>
              </div>
          );
      }

      function ProjectSelection({ user, onSelectProject, onLogout }) {
          const [pid, setPid] = useState('');
          return (
              <div className="flex items-center justify-center h-screen bg-gray-50">
                  <div className="bg-white p-8 rounded shadow-lg w-96 text-center">
                      <h2 className="text-xl font-bold mb-2">Ol√°, {user.isAnonymous ? 'Convidado' : (user.displayName || 'Usu√°rio')}!</h2>
                      <input className="w-full border p-2 mb-4 rounded" placeholder="ID do Projeto (ex: vendas-2025)" value={pid} onChange={e=>setPid(e.target.value)} />
                      <button onClick={()=>pid && onSelectProject(pid)} className="w-full bg-green-600 text-white p-2 rounded mb-2 hover:bg-green-700 font-bold">Acessar Projeto</button>
                      <button onClick={()=>onSelectProject(`proj-${Math.random().toString(36).slice(2,7)}`)} className="w-full bg-blue-100 text-blue-700 p-2 rounded mb-4 hover:bg-blue-200 font-bold">Criar Novo</button>
                      <button onClick={onLogout} className="text-red-500 text-sm hover:underline">Sair</button>
                  </div>
              </div>
          );
      }

      // --- KANBAN BOARD (CORE) ---
      function KanbanBoard({ user, projectId, storageMode, onSwitchMode, onBack }) {
      const [boardState, setBoardState] = useState(defaultBoardState);
      const [clients, setClients] = useState([]);
      const [logs, setLogs] = useState([]);
      const [pageTitle, setPageTitle] = useState('Pepper Hat Funil');
      const [isSaving, setIsSaving] = useState(false);
      
      // UI
      const [currentView, setCurrentView] = useState('kanban');
        const [showAdminMenu, setShowAdminMenu] = useState(false);
        const [showAddCard, setShowAddCard] = useState(false);
        const [editingCardId, setEditingCardId] = useState(null);
        
        // Modals & Filters
        const [showAddCategory, setShowAddCategory] = useState(false);
        const [showAddMemberModal, setShowAddMemberModal] = useState(false);
        const [showManageCategories, setShowManageCategories] = useState(false);
        const [showManageMembers, setShowManageMembers] = useState(false);
        const [isAddingColumn, setIsAddingColumn] = useState(false);
        const [showTemplateSelector, setShowTemplateSelector] = useState(false);
        
        // Google Calendar
        const [googleCalendarAuth, setGoogleCalendarAuth] = useState(null); // stores access token metadata
        const [googleClientId, setGoogleClientId] = useState(localStorage.getItem('googleCalendarClientId') || '');
        const [gapiReady, setGapiReady] = useState(false);
        const [isSyncingCalendar, setIsSyncingCalendar] = useState(false);
        const [showCalendarGuide, setShowCalendarGuide] = useState(false);
        const [showDeleteModal, setShowDeleteModal] = useState(false);
        const [cardToDelete, setCardToDelete] = useState(null);
        const [notification, setNotification] = useState(null);
        const [syncError, setSyncError] = useState(false);
        const [confirmation, setConfirmation] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
        const [undoStack, setUndoStack] = useState(null);
        
        // Sistema de Alertas
        const [notificationsEnabled, setNotificationsEnabled] = useState(localStorage.getItem('pepperhat_notifications_enabled') === 'true');
        const [notificationPermission, setNotificationPermission] = useState(typeof Notification !== 'undefined' ? Notification.permission : 'default');
        const notifiedTasksRef = useRef(new Set()); // Armazena IDs de tarefas j√° notificadas

        const [compactCards, setCompactCards] = useState(true);
        const [disablePulsing, setDisablePulsing] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const [filterCategory, setFilterCategory] = useState('');
        const [filterMember, setFilterMember] = useState('');
        const [filterActivity, setFilterActivity] = useState('');
        const [filterDuration, setFilterDuration] = useState('');
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [hideActivityDurationFields, setHideActivityDurationFields] = useState(false);

        const resizingRef = useRef({ isResizing: false, columnId: null, startX: 0, startWidth: 0 });
        const [draggedItem, setDraggedItem] = useState(null);
        const [dropTarget, setDropTarget] = useState(null);
        const pendingSaveRef = useRef({}); 
        
        const topScrollRef = useRef(null);
        const bottomScrollRef = useRef(null);
        const [scrollWidth, setScrollWidth] = useState(0);

        const getDefaultColumnId = () => {
            return (boardState.columnOrder && boardState.columnOrder.length > 0) ? boardState.columnOrder[0] : '';
        };

        const [uiState, setUiState] = useState({
            newClient: { name: '', email: '', phone: '', notes: [], rating: 3, category: '', assignedTo: '', address: '', activity: '', deadlineDate: '', deadlineTime: '', duration: '', columnId: '', isPulsing: true, link: '', value: 0 },
            newCategory: '', newColumnName: '', newTeamMemberName: ''
        });

        const appId = 'pepperhatapps';
        const getDocRef = () => {
            const path = storageMode === 'public' ? ['public', 'data'] : ['users', user.uid];
            return window.db && window.doc(window.db, 'artifacts', appId, ...path, 'pepperhat_v3', projectId);
        };

        // Load & Sync
        useEffect(() => {
            if (!window.db) return;
            const unsub = window.onSnapshot(getDocRef(), (doc) => {
                setSyncError(false);
                if (doc.exists()) {
                    const d = doc.data();
                    if (!resizingRef.current.isResizing) {
                        if (d.board) {
                            const mergedBoard = { ...defaultBoardState, ...d.board };
                            // Garantir que activityOptions sempre inclua 'Digital'
                            if (!mergedBoard.activityOptions || !mergedBoard.activityOptions.includes('Digital')) {
                                mergedBoard.activityOptions = ['Interna', 'Externa', 'Digital'];
                                // Salvar a atualiza√ß√£o para persistir
                                triggerSave({ board: mergedBoard });
                            }
                            setBoardState(mergedBoard);
                        }
                        // Merge clients? No, replace usually. 
                        // Sort by 'order' if exists, else by id or date
                        if (d.clients) {
                            const sortedClients = [...d.clients].sort((a, b) => (a.order || 0) - (b.order || 0));
                            setClients(sortedClients);
                        }
                        if (d.logs) setLogs(d.logs);
                        if (d.pageTitle) setPageTitle(d.pageTitle); 
                    }
                } else {
                    triggerSave({ board: defaultBoardState, clients: [] });
                }
            }, (err) => {
                if(err.code === 'permission-denied') {
                    setSyncError(true);
                    if(storageMode === 'public') {
                        setNotification({ msg: "Modo P√∫blico bloqueado. Mudando para Pessoal...", type: 'error' });
                        setTimeout(() => onSwitchMode('private'), 1500);
                    } else setNotification({ msg: "Erro de permiss√£o.", type: 'error' });
                }
            });
            return () => unsub();
        }, [projectId, storageMode]);

        const commit = useCallback(async () => {
            const payload = pendingSaveRef.current;
            if (Object.keys(payload).length === 0) return;
            setIsSaving(true);
            try {
                await window.setDoc(getDocRef(), { ...payload, lastUpdated: new Date().toISOString() }, { merge: true });
                pendingSaveRef.current = {};
            } catch(e) { console.error(e); }
            finally { setTimeout(() => setIsSaving(false), 500); }
        }, [projectId, storageMode]);

        const debouncedCommit = useDebounce(commit, 1000);

        const triggerSave = (data) => {
            if(data.board) setBoardState(data.board);
            if(data.clients) setClients(data.clients);
            if(data.logs) setLogs(data.logs);
            pendingSaveRef.current = { ...pendingSaveRef.current, ...data };
            debouncedCommit();
        };

        const addLogEntry = (entry) => {
            const base = { id: uid(), timestamp: new Date().toISOString() };
            const newLogs = [...logs, { ...base, ...entry }];
            triggerSave({ logs: newLogs });
        };

        // Actions
        const handleDragStart = (e, id) => { setDraggedItem(id); e.dataTransfer.setData('text', id); };
        const handleCardDragOver = (e, cardId, index, columnId) => {
            e.preventDefault();
            if (draggedItem && draggedItem !== cardId) {
                setDropTarget({ columnId, index });
            }
        };
        const handleDrop = (e, targetCol) => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text');
            if(!id) return;
            setDropTarget(null);
            const newClients = clients.map(c => {
                if(c.id === id && c.columnId !== targetCol) {
                    const oldCol = boardState.columns[c.columnId]?.title || c.columnId;
                    const newCol = boardState.columns[targetCol]?.title || targetCol;
                    const notes = [...(c.notes||[]), { text: `Movido: ${oldCol} -> ${newCol}`, timestamp: new Date().toISOString() }];
                    addLogEntry({
                        kind: 'card',
                        action: 'move',
                        cardId: c.id,
                        cardName: c.name,
                        changes: [
                            { field: 'coluna', before: oldCol, after: newCol }
                        ]
                    });
                    return { ...c, columnId: targetCol, lastUpdated: new Date().toISOString(), notes, pulsingDisabled: false };
                }
                return c;
            });
            triggerSave({ clients: newClients });
            setDraggedItem(null);
        };

        const handleFileDrop = (e, cardId) => {
            e.preventDefault();
            e.stopPropagation();
            const files = Array.from(e.dataTransfer.files);
            if(files.length > 0) {
                const newClients = clients.map(c => {
                    if(c.id === cardId) {
                        const fileNotes = files.map(f => ({ text: `Arquivo anexado: ${f.name}`, timestamp: new Date().toISOString() }));
                        return { ...c, notes: [...(c.notes||[]), ...fileNotes], lastUpdated: new Date().toISOString() };
                    }
                    return c;
                });
                triggerSave({ clients: newClients });
                notify(`${files.length} arquivo(s) anexado(s)!`);
            }
        };

        const applyTemplate = (templateKey) => {
            const template = columnTemplates[templateKey];
            if (!template) return;
            
            const newColumns = {};
            const newColumnOrder = [];
            const newColumnWidths = {};
            
            template.columns.forEach(col => {
                newColumns[col.id] = { id: col.id, title: col.title, color: col.color };
                newColumnOrder.push(col.id);
                newColumnWidths[col.id] = 280;
            });
            
            triggerSave({ 
                board: { 
                    ...boardState, 
                    columns: newColumns, 
                    columnOrder: newColumnOrder,
                    columnWidths: newColumnWidths
                } 
            });
            notify(`Template "${template.name}" aplicado com sucesso!`, 'success');
        };

        const moveColumn = (id, dir) => {
            const order = [...boardState.columnOrder];
            const idx = order.indexOf(id);
            if(idx < 0) return;
            const newIdx = dir === 'left' ? idx - 1 : idx + 1;
            if(newIdx >= 0 && newIdx < order.length && !['arquivados','descartados'].includes(order[newIdx])) {
                [order[idx], order[newIdx]] = [order[newIdx], order[idx]];
                triggerSave({ board: { ...boardState, columnOrder: order } });
                const col = boardState.columns[id];
                addLogEntry({
                    kind: 'column',
                    action: 'move',
                    columnId: id,
                    title: col?.title || id,
                    changes: [
                        { field: 'posi√ß√£o', before: idx, after: newIdx }
                    ]
                });
            }
        };

        const changeColumnColor = (id) => {
            const col = boardState.columns[id];
            const oldColor = col?.color || null;
            const newColor = softPastelColors[Math.floor(Math.random()*softPastelColors.length)];
            triggerSave({ board: { ...boardState, columns: { ...boardState.columns, [id]: { ...col, color: newColor } } } });
            addLogEntry({
                kind: 'column',
                action: 'color',
                columnId: id,
                title: col?.title || id,
                changes: oldColor ? [{ field: 'cor', before: oldColor, after: newColor }] : []
            });
        };

        const handleUndo = () => {
            if(!undoStack) return;
            if(undoStack.type === 'card') {
                triggerSave({ clients: [...clients, undoStack.data] });
            } else if (undoStack.type === 'column') {
                const newCols = { ...boardState.columns, [undoStack.data.id]: undoStack.data };
                const newOrder = [...boardState.columnOrder];
                const idx = newOrder.indexOf('arquivados');
                if(idx > -1) newOrder.splice(idx, 0, undoStack.data.id);
                else newOrder.push(undoStack.data.id);
                
                triggerSave({ board: { ...boardState, columns: newCols, columnOrder: newOrder } });
                if(undoStack.relatedClients) {
                     const restoredClients = [...clients, ...undoStack.relatedClients.filter(rc => !clients.find(c => c.id === rc.id))];
                     triggerSave({ clients: restoredClients });
                }
            }
            setUndoStack(null);
        };

        // Resizing Logic
        useEffect(() => {
            const onMove = (e) => {
                const r = resizingRef.current;
                if(!r.isResizing) return;
                const w = Math.max(220, Math.min(720, r.startW + (e.clientX - r.startX)));
                setBoardState(p => ({ ...p, columnWidths: { ...p.columnWidths, [r.colId]: w } }));
            };
            const onUp = () => {
                if(resizingRef.current.isResizing) {
                    setBoardState(curr => { triggerSave({ board: curr }); return curr; });
                    resizingRef.current = { isResizing: false };
                }
            };
            window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
            return () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
        }, []);
        
        useEffect(() => {
            const top = topScrollRef.current;
            const bottom = bottomScrollRef.current;
            if (!top || !bottom) return;
            const handleTopScroll = () => { if(bottom) bottom.scrollLeft = top.scrollLeft; };
            const handleBottomScroll = () => { if(top) top.scrollLeft = bottom.scrollLeft; };
            top.addEventListener('scroll', handleTopScroll);
            bottom.addEventListener('scroll', handleBottomScroll);
            const updateWidth = () => { if(bottom) setScrollWidth(bottom.scrollWidth); };
            updateWidth();
            window.addEventListener('resize', updateWidth);
            return () => {
                top.removeEventListener('scroll', handleTopScroll);
                bottom.removeEventListener('scroll', handleBottomScroll);
                window.removeEventListener('resize', updateWidth);
            };
        }, [boardState, clients, currentView]);

        useEffect(() => { if (bottomScrollRef.current) setScrollWidth(bottomScrollRef.current.scrollWidth); }, [boardState.columnOrder, boardState.columnWidths]);

        // Helpers
        const notify = (msg, type='success') => { setNotification({msg, type}); setTimeout(()=>setNotification(null), 4000); };
        const requestConfirmation = (title, msg, action) => setConfirmation({ isOpen: true, title, message: msg, onConfirm: action });
        const handleConfirmAction = () => {
            if (confirmation.onConfirm) confirmation.onConfirm();
            setConfirmation({ ...confirmation, isOpen: false });
        };

        // Sistema de Alertas - Fun√ß√µes
        const requestNotificationPermission = async () => {
            if (typeof Notification === 'undefined' || !('Notification' in window)) {
                notify('Seu navegador n√£o suporta notifica√ß√µes', 'error');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                setNotificationPermission('granted');
                setNotificationsEnabled(true);
                localStorage.setItem('pepperhat_notifications_enabled', 'true');
                notify('Notifica√ß√µes ativadas! Voc√™ receber√° alertas 1 hora antes das tarefas.', 'success');
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                setNotificationPermission(permission);
                if (permission === 'granted') {
                    setNotificationsEnabled(true);
                    localStorage.setItem('pepperhat_notifications_enabled', 'true');
                    notify('Notifica√ß√µes ativadas! Voc√™ receber√° alertas 1 hora antes das tarefas.', 'success');
                    return true;
                } else {
                    notify('Permiss√£o de notifica√ß√µes negada. Ative nas configura√ß√µes do navegador.', 'error');
                    return false;
                }
            } else {
                notify('Permiss√£o de notifica√ß√µes negada. Ative nas configura√ß√µes do navegador.', 'error');
                return false;
            }
        };

        const toggleNotifications = async () => {
            if (!notificationsEnabled) {
                await requestNotificationPermission();
            } else {
                setNotificationsEnabled(false);
                localStorage.setItem('pepperhat_notifications_enabled', 'false');
                notify('Notifica√ß√µes desativadas', 'success');
            }
        };

        const checkUpcomingTasks = useCallback(() => {
            if (!notificationsEnabled || typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
            
            const now = new Date();
            const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000); // 1 hora
            
            clients.forEach(card => {
                if (!card.deadlineDate || !card.deadlineTime) return;
                
                try {
                    const deadlineTime = card.deadlineTime || '00:00';
                    const deadlineDateTime = new Date(`${card.deadlineDate}T${deadlineTime}:00`);
                    
                    // Verifica se est√° entre agora e 1 hora a partir de agora
                    if (deadlineDateTime >= now && deadlineDateTime <= oneHourFromNow) {
                        const taskId = `${card.id}_${deadlineDateTime.getTime()}`;
                        
                        // Evita notifica√ß√µes duplicadas
                        if (!notifiedTasksRef.current.has(taskId)) {
                            notifiedTasksRef.current.add(taskId);
                            
                            const timeUntil = Math.round((deadlineDateTime - now) / 1000 / 60); // minutos
                            const timeText = timeUntil < 1 ? 'menos de 1 minuto' : `${timeUntil} minuto${timeUntil > 1 ? 's' : ''}`;
                            
                            new Notification(`Tarefa iniciando em breve!`, {
                                body: `${card.name || 'Tarefa sem nome'} - Inicia em ${timeText}`,
                                icon: '/favicon.ico', // Pode ser ajustado
                                tag: taskId,
                                requireInteraction: false
                            });
                        }
                    }
                    
                    // Remove IDs antigos (tarefas que j√° passaram h√° mais de 2 horas)
                    const twoHoursAgo = now.getTime() - (2 * 60 * 60 * 1000);
                    if (deadlineDateTime.getTime() < twoHoursAgo) {
                        notifiedTasksRef.current.delete(taskId);
                    }
                } catch (err) {
                    console.error('Erro ao verificar tarefa:', err);
                }
            });
        }, [notificationsEnabled, clients]);

        // Sistema de Alertas - Verifica√ß√£o peri√≥dica
        useEffect(() => {
            if (!notificationsEnabled || typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
            
            // Verifica imediatamente
            checkUpcomingTasks();
            
            // Verifica a cada minuto
            const interval = setInterval(() => {
                checkUpcomingTasks();
            }, 60000); // 60 segundos
            
            return () => clearInterval(interval);
        }, [notificationsEnabled, checkUpcomingTasks]);

        // Import/Export
        const saveToLocalFile = () => {
            const data = { boardState, clients, projectId };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `backup.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            notify("Exportado!");
        };

        const importFromLocalFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    if(!d.boardState || !d.clients) throw new Error("Formato inv√°lido");
                    requestConfirmation('Importar Backup', 'Isso substituir√° todos os dados atuais na nuvem. Deseja continuar?', () => {
                        triggerSave({ board: d.boardState, clients: d.clients });
                        notify("Importado com sucesso!");
                    });
                } catch(err) { notify(err.message, 'error'); }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        };

        const importFromGoogleSheets = () => {
            let url;
            try { url = prompt('URL p√∫blica da planilha:'); } catch(e) { notify("Prompt bloqueado", 'error'); return; }
            if(!url) return;
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if(!match) { notify('URL inv√°lida', 'error'); return; }
            const csvUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv`;
            fetch(csvUrl).then(r => r.text()).then(csv => {
                const lines = csv.split('\n');
                const newCards = [];
                for(let i=1; i<lines.length; i++) {
                    if(lines[i].trim()) {
                        const v = lines[i].split(',').map(x => x.trim().replace(/"/g, ''));
                        newCards.push({
                            id: uid(), name: v[0], email: v[1], phone: v[2], category: v[3], assignedTo: v[4],
                            rating: parseInt(v[5])||0, columnId: 'primeiro-contato',
                            createdAt: new Date().toISOString(), lastUpdated: new Date().toISOString()
                        });
                    }
                }
                requestConfirmation('Importar Planilha', `Importar ${newCards.length} cards?`, () => {
                    triggerSave({ clients: [...clients, ...newCards] });
                    notify(`${newCards.length} cards importados!`);
                });
            }).catch(() => notify('Erro ao baixar planilha.', 'error'));
        };

        const exportToGoogleSheets = () => {
            const headers = ['Nome', 'Email', 'Telefone', 'Categoria', 'Respons√°vel', 'Classifica√ß√£o', 'Coluna', 'Anota√ß√µes', 'Criado Em', 'Atualizado Em', 'Endere√ßo', 'Atividade', 'Prazo Data', 'Prazo Hora', 'Dura√ß√£o', 'Link'];
            const csv = [headers.join(','), ...clients.map(c => [
                `"${c.name||''}"`, `"${c.email||''}"`, `"${c.phone||''}"`, `"${c.category||''}"`, `"${c.assignedTo||''}"`,
                c.rating||0, `"${boardState.columns[c.columnId]?.title || c.columnId}"`, `"${(c.notes||[]).map(n=>n.text).join('|')}"`,
                `"${new Date(c.createdAt).toLocaleDateString()}"`, `"${new Date(c.lastUpdated).toLocaleDateString()}"`,
                `"${c.address||''}"`, `"${c.activity||''}"`, `"${c.deadlineDate||''}"`, `"${c.deadlineTime||''}"`, `"${c.duration||''}"`, `"${c.link||''}"`
            ].join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'kanban_export.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            notify("CSV exportado!");
        };

        // Google Calendar Sync
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const tokenClientRef = useRef(null);
        const initialClientsLoadRef = useRef(true);
        const lastSyncedSignatureRef = useRef(null);

        const computeClientsSignature = useCallback((list) => {
            return JSON.stringify(list.map(c => ({
                id: c.id,
                lastUpdated: c.lastUpdated,
                eventId: c.googleCalendarEventId,
                deadline: c.deadlineDate,
                time: c.deadlineTime
            })));
        }, []);
        const resetGoogleCalendarAuth = useCallback(() => {
            const token = gapi?.client?.getToken?.()?.access_token;
            if (token && window.google?.accounts?.oauth2?.revoke) {
                window.google.accounts.oauth2.revoke(token, () => {});
            }
            gapi?.client?.setToken('');
            setGoogleCalendarAuth(null);
            localStorage.removeItem('googleCalendarClientId');
            setGoogleClientId('');
            notify('Dados do Google Calendar apagados. Reinsira o Client ID.', 'success');
        }, []);

        const requireGoogleClientId = () => {
            if (googleClientId) return googleClientId;
            const entered = prompt('Cole o Client ID OAuth do Google Calendar (termina com .apps.googleusercontent.com)');
            if (entered && entered.trim()) {
                const sanitized = entered.trim();
                localStorage.setItem('googleCalendarClientId', sanitized);
                setGoogleClientId(sanitized);
                notify('Client ID salvo. Tentando conectar...', 'success');
                return sanitized;
            }
            notify('√â necess√°rio informar o Client ID do Google para conectar.', 'error');
            return null;
        };

        const loadGapiClient = () => {
            return new Promise((resolve, reject) => {
                gapi.load('client', {
                    callback: resolve,
                    onerror: () => reject(new Error('Falha ao carregar Google API')),
                });
            });
        };

        const initGoogleCalendar = async () => {
            if (typeof gapi === 'undefined') {
                notify('Google API n√£o carregada. Recarregue a p√°gina.', 'error');
                return;
            }
            const clientId = requireGoogleClientId();
            if (!clientId) return;

            if (!gapiReady) {
                try {
                    await loadGapiClient();
                    await gapi.client.init({});
                    await gapi.client.load('calendar', 'v3');
                    setGapiReady(true);
                } catch (err) {
                    console.error('Erro ao inicializar gapi:', err);
                    notify('N√£o foi poss√≠vel iniciar o Google API Client.', 'error');
                    return;
                }
            }

            if (!tokenClientRef.current) {
                tokenClientRef.current = google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: SCOPES,
                    callback: () => {},
                });
            }
        };

        useEffect(() => {
            if (typeof gapi !== 'undefined' && googleClientId) {
                initGoogleCalendar();
            }
        }, [googleClientId]);

        useEffect(() => {
            if (initialClientsLoadRef.current) {
                initialClientsLoadRef.current = false;
                lastSyncedSignatureRef.current = computeClientsSignature(clients);
                return;
            }
            if (!googleCalendarAuth) return;
            if (!clients.some(c => c.deadlineDate)) return;
            const currentSig = computeClientsSignature(clients);
            if (currentSig === lastSyncedSignatureRef.current) return;
            const t = setTimeout(() => {
                syncToGoogleCalendar();
            }, 400);
            return () => clearTimeout(t);
        }, [clients, googleCalendarAuth, computeClientsSignature]);

        const handleGoogleCalendarAuth = async () => {
            if (typeof gapi === 'undefined') {
                notify('Google API n√£o carregada. Recarregue a p√°gina.', 'error');
                return;
            }
            const clientId = requireGoogleClientId();
            if (!clientId) return;

            try {
                await initGoogleCalendar();
                if (!tokenClientRef.current) return;

                return await new Promise((resolve, reject) => {
                    tokenClientRef.current.callback = (resp) => {
                        if (resp?.error) {
                            console.error('Token error:', resp);
                            notify('Erro ao conectar com Google Calendar: ' + (resp.error_description || resp.error), 'error');
                            reject(resp);
                            return;
                        }
                        const token = { accessToken: resp.access_token, expiresIn: resp.expires_in };
                        gapi.client.setToken({ access_token: resp.access_token });
                        setGoogleCalendarAuth(token);
                        setShowAdminMenu(false);
                        notify('Conectado ao Google Calendar!', 'success');
                        resolve(token);
                    };
                    tokenClientRef.current.requestAccessToken({ prompt: googleCalendarAuth ? '' : 'consent' });
                });
            } catch (err) {
                console.error('Erro na autentica√ß√£o:', err);
                const details = err?.message || err?.error || err?.error_description || 'Ver console para detalhes';
                notify('Erro ao conectar com Google Calendar: ' + details, 'error');
            }
        };

        const findExistingEventId = async (cardId) => {
            try {
                const res = await gapi.client.calendar.events.list({
                    calendarId: 'primary',
                    privateExtendedProperty: `cardId=${cardId}`,
                    maxResults: 1,
                    singleEvents: true,
                    orderBy: 'startTime',
                });
                const items = res.result?.items || [];
                if (items.length > 0) return items[0].id;
            } catch (err) {
                console.error('Erro ao buscar evento existente:', err);
            }
            return null;
        };

        const syncToGoogleCalendar = async () => {
            if (!googleCalendarAuth || !gapi.client.getToken()?.access_token) {
                const token = await handleGoogleCalendarAuth();
                if (!token && !gapi.client.getToken()?.access_token) return; // Se ainda n√£o autenticou, sair
            }
            setIsSyncingCalendar(true);
            try {
                const cardsWithDeadline = clients.filter(c => c.deadlineDate);
                if (cardsWithDeadline.length === 0) {
                    notify('Nenhum card com prazo encontrado para sincronizar', 'error');
                    setIsSyncingCalendar(false);
                    return;
                }
                let synced = 0;
                let errors = 0;

                for (const card of cardsWithDeadline) {
                    try {
                        const deadlineDate = card.deadlineDate;
                        const deadlineTime = card.deadlineTime || '09:00';
                        const startDateTime = new Date(`${deadlineDate}T${deadlineTime}:00`);
                        const endDateTime = new Date(startDateTime.getTime() + (60 * 60 * 1000)); // 1 hora padr√£o

                        const event = {
                            summary: card.name || 'Tarefa sem nome',
                            description: [
                                card.category && `Categoria: ${card.category}`,
                                card.assignedTo && `Respons√°vel: ${card.assignedTo}`,
                                card.address && `Endere√ßo: ${card.address}`,
                                card.phone && `Telefone: ${card.phone}`,
                                card.email && `Email: ${card.email}`,
                                card.link && `Link: ${card.link}`,
                                (card.notes && card.notes.length > 0) && `Notas: ${card.notes.map(n => n.text).join('; ')}`,
                                `Status: ${boardState.columns[card.columnId]?.title || card.columnId}`
                            ].filter(Boolean).join('\n'),
                            start: {
                                dateTime: startDateTime.toISOString(),
                                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            },
                            end: {
                                dateTime: endDateTime.toISOString(),
                                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            },
                            reminders: {
                                useDefault: false,
                                overrides: [
                                    { method: 'popup', minutes: 30 },
                                    { method: 'popup', minutes: 1440 } // 1 dia antes
                                ]
                            }
                        };

                        // Verificar se j√° existe evento (usando card.id como identificador)
                        let existingEventId = card.googleCalendarEventId;
                        if (!existingEventId) {
                            existingEventId = await findExistingEventId(card.id);
                            if (existingEventId) {
                                const updatedCard = { ...card, googleCalendarEventId: existingEventId };
                                triggerSave({ clients: clients.map(c => c.id === card.id ? updatedCard : c) });
                            }
                        }

                        // Armazenar cardId como propriedade privada para futuras deduplica√ß√µes
                        event.extendedProperties = { private: { cardId: card.id } };
                        if (existingEventId) {
                            await gapi.client.calendar.events.update({
                                calendarId: 'primary',
                                eventId: existingEventId,
                                resource: event
                            });
                        } else {
                            const response = await gapi.client.calendar.events.insert({
                                calendarId: 'primary',
                                resource: event
                            });
                            // Salvar ID do evento no card
                            const updatedCard = { ...card, googleCalendarEventId: response.result.id };
                            triggerSave({ clients: clients.map(c => c.id === card.id ? updatedCard : c) });
                        }
                        synced++;
                    } catch (err) {
                        console.error(`Erro ao sincronizar card ${card.id}:`, err);
                        errors++;
                    }
                }

                notify(`Sincroniza√ß√£o conclu√≠da! ${synced} eventos sincronizados${errors > 0 ? `, ${errors} erros` : ''}`, errors > 0 ? 'error' : 'success');
            } catch (err) {
                console.error('Erro na sincroniza√ß√£o:', err);
                notify('Erro ao sincronizar com Google Calendar: ' + (err.message || 'Erro desconhecido'), 'error');
            } finally {
                setIsSyncingCalendar(false);
        lastSyncedSignatureRef.current = computeClientsSignature(clients);
            }
        };

        const deleteCalendarEvent = async (eventId) => {
            if (!eventId) return;
            if (typeof gapi === 'undefined') return;
            try {
                if (!gapi.client.getToken()?.access_token) {
                    const token = await handleGoogleCalendarAuth();
                    if (!token && !gapi.client.getToken()?.access_token) return;
                }
                await gapi.client.calendar.events.delete({
                    calendarId: 'primary',
                    eventId
                });
                notify('Evento removido do Google Calendar', 'success');
            } catch (err) {
                console.error('Erro ao excluir evento do Calendar:', err);
                notify('N√£o foi poss√≠vel excluir do Google Calendar.', 'error');
            }
        };

        const getColumns = () => boardState.columnOrder.map(id => boardState.columns[id]).filter(Boolean);

        return (
            <div className="max-w-full mx-auto p-2 sm:p-4 md:p-8 fade-in bg-stone-50">
                {notification && <div className={`fixed top-4 right-4 p-4 rounded shadow-xl z-50 text-white ${notification.type==='error'?'bg-red-500':'bg-green-600'}`}>{notification.msg} {syncError && <button onClick={()=>onSwitchMode('private')} className="ml-2 underline">Mudar Pessoal</button>}</div>}
                
                {confirmation.isOpen && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
                        <div className="bg-white p-6 rounded w-96">
                            <h3 className="font-bold text-lg mb-2">{confirmation.title}</h3>
                            <p className="mb-4 text-gray-600">{confirmation.message}</p>
                            <div className="flex justify-end gap-2">
                                <button onClick={()=>setConfirmation({...confirmation, isOpen: false})} className="px-4 py-2 bg-gray-200 rounded">Cancelar</button>
                                <button onClick={handleConfirmAction} className="px-4 py-2 bg-blue-600 text-white rounded">Confirmar</button>
                            </div>
                        </div>
                    </div>
                )}
                
                <div className="fixed bottom-4 right-4 z-40 flex gap-2">
                     <div className={`px-3 py-1 rounded-full text-xs font-bold shadow-lg cursor-pointer transition-all ${storageMode === 'public' ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-600'}`} onClick={() => onSwitchMode('public')}>Colaborativo</div>
                     <div className={`px-3 py-1 rounded-full text-xs font-bold shadow-lg cursor-pointer transition-all ${storageMode === 'private' ? 'bg-purple-500 text-white' : 'bg-gray-300 text-gray-600'}`} onClick={() => onSwitchMode('private')}>Pessoal</div>
                </div>

                <header className="flex justify-between items-center mb-4 shrink-0">
                    <div>
                        <div className="flex items-center gap-2 text-sm text-gray-500">
                            <button onClick={onBack} className="hover:underline">‚Üê Voltar</button> ‚Ä¢ <span className="font-mono bg-gray-100 px-1 rounded">{projectId}</span>
                        </div>
                        <h1 className="text-2xl font-bold text-gray-800">{pageTitle}</h1>
                    </div>
                    <div className="flex gap-2 items-center">
                        {undoStack && <button onClick={handleUndo} className="bg-yellow-500 text-white px-3 py-1 rounded shadow animate-pulse font-bold">‚Ü© Desfazer</button>}
                        <span className={`text-xs font-bold px-2 py-1 rounded uppercase ${isSaving ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>{isSaving ? 'Salvando...' : 'Salvo'}</span>
                        <div className="relative">
                            <button onClick={()=>setShowAdminMenu(!showAdminMenu)} className="bg-gray-800 text-white px-3 py-1 rounded shadow">Op√ß√µes</button>
                            {showAdminMenu && (
                                <div className="absolute right-0 mt-1 w-56 bg-white rounded shadow-xl border py-1 z-20 text-sm">
                                    <button onClick={()=>{setShowAddCard(true); setEditingCardId(null); setShowAdminMenu(false);}} className="block w-full text-left px-4 py-2 hover:bg-gray-100">+ Card</button>
                                    <button onClick={()=>{setIsAddingColumn(true); setShowAdminMenu(false);}} className="block w-full text-left px-4 py-2 hover:bg-gray-100">+ Coluna</button>
                                    <hr className="my-1"/>
                                    <button onClick={()=>{setShowManageCategories(true); setShowAdminMenu(false);}} className="block w-full text-left px-4 py-2 hover:bg-gray-100">üìã Gerenciar Categorias</button>
                                    <button onClick={()=>{setShowManageMembers(true); setShowAdminMenu(false);}} className="block w-full text-left px-4 py-2 hover:bg-gray-100">üë• Gerenciar Respons√°veis</button>
                                    <button onClick={()=>{triggerSave({ board: {...boardState, columnsLocked: !boardState.columnsLocked} }); setShowAdminMenu(false);}} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-purple-600 font-bold">{boardState.columnsLocked ? 'üîì Destravar Colunas' : 'üîí Travar Colunas'}</button>
                                    <hr className="my-1"/>
                                    <button onClick={saveToLocalFile} className="block w-full text-left px-4 py-2 hover:bg-gray-100">Backup JSON</button>
                                    <button onClick={() => document.getElementById('importFile').click()} className="block w-full text-left px-4 py-2 hover:bg-gray-100">Importar JSON</button>
                                    <button onClick={exportToGoogleSheets} className="block w-full text-left px-4 py-2 hover:bg-gray-100">Exportar CSV</button>
                                    <button onClick={importFromGoogleSheets} className="block w-full text-left px-4 py-2 hover:bg-gray-100">Importar Sheets</button>
                                    <hr className="my-1"/>
                                    <button onClick={()=>{setShowCalendarGuide(true); setShowAdminMenu(false);}} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-blue-600 font-bold">üìñ Guia: Configurar Google Calendar</button>
                                    <button onClick={()=>{ resetGoogleCalendarAuth(); setShowAdminMenu(false); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-orange-600">üîÅ Alterar Client ID</button>
                                    <button onClick={googleCalendarAuth ? syncToGoogleCalendar : handleGoogleCalendarAuth} className="block w-full text-left px-4 py-2 hover:bg-gray-100" disabled={isSyncingCalendar}>
                                        {isSyncingCalendar ? 'üîÑ Sincronizando...' : (googleCalendarAuth ? 'üìÖ Sincronizar Google Calendar' : 'üìÖ Conectar Google Calendar')}
                                    </button>
                                    <hr className="my-1"/>
                                    <button 
                                        onClick={() => { toggleNotifications(); setShowAdminMenu(false); }} 
                                        className={`block w-full text-left px-4 py-2 hover:bg-gray-100 ${notificationsEnabled ? 'text-green-600 font-bold' : 'text-gray-800'}`}
                                    >
                                        {notificationsEnabled ? 'üîî Notifica√ß√µes: Ativadas' : 'üîï Notifica√ß√µes: Desativadas'}
                                    </button>
                                    {googleCalendarAuth && (
                                        <button
                                            onClick={() => {
                                                const token = gapi.client.getToken()?.access_token;
                                                if (token && window.google?.accounts?.oauth2?.revoke) {
                                                    window.google.accounts.oauth2.revoke(token, () => {
                                                        gapi.client.setToken('');
                                                        setGoogleCalendarAuth(null);
                                                        notify('Desconectado do Google Calendar', 'success');
                                                    });
                                                } else {
                                                    gapi.client.setToken('');
                                                    setGoogleCalendarAuth(null);
                                                    notify('Desconectado do Google Calendar', 'success');
                                                }
                                            }}
                                            className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600"
                                        >
                                            Desconectar Calendar
                                        </button>
                                    )}
                                    <div className="border-t my-1"></div>
                                    <button onClick={onBack} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">Sair</button>
                                </div>
                            )}
                        </div>
                        <input id="importFile" type="file" accept=".json" onChange={importFromLocalFile} className="hidden" />
                    </div>
                </header>

        <div className="flex flex-wrap gap-2 mb-4 items-center bg-white p-2 rounded shadow-sm shrink-0">
                    <div className="flex bg-gray-100 rounded p-1">
                        {['kanban', 'calendar', 'list', 'logs'].map(v => <button key={v} onClick={()=>setCurrentView(v)} className={`px-3 py-1 rounded text-sm capitalize ${currentView===v ? 'bg-white shadow font-bold' : 'text-gray-500'}`}>{v}</button>)}
                    </div>
                    <div className="w-px h-6 bg-gray-300 mx-1"></div>
                    <button onClick={()=>setCompactCards(!compactCards)} className="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">{compactCards ? 'Expandir' : 'Compactar'}</button>
                    <button onClick={()=>setDisablePulsing(!disablePulsing)} className="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">{disablePulsing ? 'Ativar' : 'Desativar'} Pulso</button>
                    
                    <div className="flex-grow"></div>
                    <select className="border rounded p-1 text-sm" value={filterCategory} onChange={e=>setFilterCategory(e.target.value)}><option value="">Categ.</option>{boardState.categories.map(c=><option key={c} value={c}>{c}</option>)}</select>
                    <select value={filterMember} onChange={(e) => setFilterMember(e.target.value)} className="p-1 text-sm border rounded-md max-w-[120px]"><option value="">Todos Memb.</option>{boardState.teamMembers.map(m => <option key={m} value={m}>{m}</option>)}</select>
                    <select value={filterActivity} onChange={(e) => setFilterActivity(e.target.value)} className="p-1 text-sm border rounded-md max-w-[120px]"><option value="">Atividade</option>{boardState.activityOptions.map(a => <option key={a} value={a}>{a}</option>)}</select>
                    <select value={filterDuration} onChange={(e) => setFilterDuration(e.target.value)} className="p-1 text-sm border rounded-md max-w-[120px]"><option value="">Dura√ß√£o</option>{boardState.durationOptions.map(d => <option key={d} value={d}>{d}</option>)}</select>
                    
                    <input type="text" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="px-3 py-1 border rounded-md text-sm w-32 focus:w-48 transition-all outline-none" />
                </div>

                {/* SCROLLBAR SUPERIOR */}
                {currentView === 'kanban' && (
                    <div ref={topScrollRef} className="overflow-x-auto h-4 mb-1 custom-scrollbar flex-shrink-0">
                        <div style={{ width: scrollWidth, height: '1px' }}></div>
                    </div>
                )}

                {/* KANBAN VIEW */}
                {currentView === 'kanban' && (boardState.columnOrder || []).length === 0 ? (
                    <div className="flex-grow flex items-center justify-center p-8">
                        <div className="bg-white rounded-xl shadow-xl p-8 max-w-4xl w-full">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">üìã</div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">Seu Kanban est√° vazio!</h2>
                                <p className="text-gray-600 text-lg">Escolha um template abaixo para come√ßar rapidamente ou crie colunas personalizadas.</p>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                {Object.entries(columnTemplates).map(([key, template]) => (
                                    <div 
                                        key={key}
                                        onClick={() => applyTemplate(key)}
                                        className="border-2 border-gray-200 rounded-lg p-6 hover:border-purple-500 hover:shadow-lg transition-all cursor-pointer bg-gradient-to-br from-white to-gray-50 group"
                                    >
                                        <div className="flex items-start gap-3 mb-3">
                                            <span className="text-4xl">{template.icon}</span>
                                            <div className="flex-1">
                                                <h3 className="font-bold text-lg text-gray-800 group-hover:text-purple-600 transition-colors">{template.name}</h3>
                                                <p className="text-sm text-gray-600 mt-1">{template.description}</p>
                                            </div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-gray-200">
                                            <div className="flex flex-wrap gap-2">
                                                {template.columns.map((col, idx) => (
                                                    <span 
                                                        key={idx}
                                                        className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700"
                                                        style={{ backgroundColor: col.color + '40' }}
                                                    >
                                                        {col.title}
                                                    </span>
                                                ))}
                                            </div>
                                            <div className="mt-3 text-xs text-gray-500">
                                                {template.columns.length} colunas
                                            </div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-gray-200">
                                            <button className="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                                                Usar este template ‚Üí
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="text-center pt-6 border-t border-gray-200">
                                <p className="text-gray-600 mb-4">Ou prefere criar suas pr√≥prias colunas?</p>
                                <button 
                                    onClick={() => setIsAddingColumn(true)}
                                    className="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors"
                                >
                                    + Criar Coluna Personalizada
                                </button>
                            </div>
                        </div>
                    </div>
                ) : currentView === 'kanban' ? (
                    <div ref={bottomScrollRef} className="flex-grow overflow-x-auto overflow-y-hidden flex gap-2 sm:gap-4 pb-2 custom-scrollbar" style={{ minWidth: 0, WebkitOverflowScrolling: 'touch' }}>
                        {(boardState.columnOrder||[]).map(colId => {
                            const col = boardState.columns[colId];
                            if(!col) return null;
                            
                            // Filter AND Sort cards (by 'order')
                            const colCards = clients
                                .filter(c => c.columnId === colId)
                                .filter(c => !filterCategory || c.category === filterCategory)
                                .filter(c => !filterMember || c.assignedTo === filterMember)
                                .filter(c => !filterActivity || c.activity === filterActivity)
                                .filter(c => !filterDuration || c.duration === filterDuration)
                                .filter(c => !searchTerm || (c.name||'').toLowerCase().includes(searchTerm.toLowerCase()) || (c.address||'').toLowerCase().includes(searchTerm.toLowerCase()) || (c.notes||[]).some(n => n.text.toLowerCase().includes(searchTerm.toLowerCase())))
                                .sort((a, b) => (a.order || 0) - (b.order || 0));

                            const width = boardState.columnWidths?.[colId] ?? 280;

                            return (
                                <div key={col.id} onDragOver={e=>{e.preventDefault(); if(draggedItem) setDropTarget({ columnId: colId, index: colCards.length });}} onDrop={e=>handleDrop(e, colId)} onDragLeave={()=>setDropTarget(null)}
                                     className="flex-shrink-0 flex flex-col bg-gray-50 rounded-xl shadow border border-gray-200 h-full max-h-full relative"
                                     style={{ width: width, minWidth: 'min(220px, calc(100vw - 3rem))', maxWidth: 'calc(100vw - 3rem)', backgroundColor: col.color || '#f3f4f6' }}>
                                    
                                    <div className="p-3 font-bold text-gray-700 flex justify-between items-center border-b border-black/5">
                                        <span>{col.title} <span className="text-xs bg-white/50 px-1 rounded">{colCards.length}</span></span>
                                        {!boardState.columnsLocked ? (
                                            <div className="flex gap-1">
                                                {!['arquivados','descartados'].includes(colId) && (
                                                    <>
                                                        <button onClick={()=>moveColumn(colId, 'left')} className="hover:bg-black/10 rounded px-1">‚Üê</button>
                                                        <button onClick={()=>moveColumn(colId, 'right')} className="hover:bg-black/10 rounded px-1">‚Üí</button>
                                                        <button onClick={()=>changeColumnColor(colId)} className="hover:bg-black/10 rounded px-1">üé®</button>
                                                    </>
                                                )}
                                                <button onClick={() => requestConfirmation('Excluir Coluna', `Tem certeza que deseja excluir a coluna "${col.title}"?`, () => {
                                                    setUndoStack({ type: 'column', data: col, relatedClients: colCards });
                                                    addLogEntry({
                                                        kind: 'column',
                                                        action: 'delete',
                                                        columnId: colId,
                                                        title: col.title,
                                                        changes: [
                                                            { field: 'cards_afetados', before: colCards.length, after: 0 }
                                                        ]
                                                    });
                                                    triggerSave({ board: { ...boardState, columns: Object.fromEntries(Object.entries(boardState.columns).filter(([k])=>k!==colId)), columnOrder: boardState.columnOrder.filter(id=>id!==colId) }, clients: clients.filter(c => c.columnId !== colId) });
                                                })} className="text-xs hover:text-red-600">üóë</button>
                                            </div>
                                        ) : (
                                            <div className="text-xs font-mono text-green-600">
                                                üí≤{new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(colCards.reduce((sum, card) => sum + (card.value || 0), 0))}
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="p-2 overflow-y-auto flex-grow space-y-2 custom-scrollbar">
                                        {colCards.map((c, idx) => (
                                            <div key={c.id} onDragOver={(e) => handleCardDragOver(e, c.id, idx, colId)}>
                                                {/* LINE INDICATOR */}
                                                {dropTarget && dropTarget.columnId === colId && dropTarget.index === idx && (
                                                    <div className="h-1 bg-blue-500 rounded my-1 animate-pulse" />
                                                )}
                                                <Card card={c} compact={compactCards} disablePulsing={disablePulsing} 
                                                      onDragStart={handleDragStart} onFileDrop={handleFileDrop} 
                                                      onClick={()=>{setEditingCardId(c.id); setShowAddCard(true);}} />
                                                
                                                {/* Handle last item indicator */}
                                                {dropTarget && dropTarget.columnId === colId && dropTarget.index === idx + 1 && idx === colCards.length - 1 && (
                                                    <div className="h-1 bg-blue-500 rounded my-1 animate-pulse" />
                                                )}
                                            </div>
                                        ))}
                                        {/* If list is empty, show indicator here if dragging over column */}
                                        {colCards.length === 0 && dropTarget && dropTarget.columnId === colId && (
                                            <div className="h-1 bg-blue-500 rounded my-1 animate-pulse" />
                                        )}
                                        
                                        <button onClick={()=>{setUiState(s=>({...s, newClient:{...s.newClient, columnId: colId}})); setEditingCardId(null); setShowAddCard(true);}} className="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:bg-white hover:border-purple-400 transition-colors">+ Novo</button>
                                    </div>
                                    
                                    <div onMouseDown={e => { resizingRef.current = { isResizing: true, colId: colId, startX: e.clientX, startW: width }; e.preventDefault(); }}
                                         className="absolute top-0 right-0 w-4 h-full cursor-col-resize z-10 hover:bg-blue-500/20" style={{right: -2}} />
                                </div>
                            );
                        })}
                    </div>
                ) : null}

                {(currentView === 'calendar' || currentView === 'list') && (
                    <div className="bg-white rounded-xl shadow p-6 h-full overflow-auto">
                        <CalendarDisplay clients={clients} view={currentView} selectedDate={selectedDate} setSelectedDate={setSelectedDate} setEditingCardId={(id)=>{setEditingCardId(id); setShowAddCard(true);}} filters={{filterCategory, searchTerm}} />
                    </div>
                )}

                {currentView === 'logs' && (
                    <div className="bg-white rounded-xl shadow p-4 h-full overflow-auto text-xs leading-tight">
                        <h2 className="text-sm font-bold mb-2 text-gray-700">üìú Logs de atividade</h2>
                        {(!logs || logs.length === 0) && (
                            <p className="text-[11px] text-gray-400 italic">Nenhum registro ainda. Crie, edite ou exclua cards/colunas para come√ßar o hist√≥rico.</p>
                        )}
                        <div className="mt-1 space-y-1 font-mono">
                            {[...logs].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map((entry, idx) => {
                                const d = new Date(entry.timestamp);
                                const dia   = String(d.getDate()).padStart(2,'0');
                                const mes   = String(d.getMonth()+1).padStart(2,'0');
                                const hora  = String(d.getHours()).padStart(2,'0');
                                const min   = String(d.getMinutes()).padStart(2,'0');
                                const sec   = String(d.getSeconds()).padStart(2,'0');
                                const ts = `${dia}/${mes} ${hora}:${min}:${sec}`;
                                const kindLabel = entry.kind === 'column' ? 'COLUNA' : 'CARD';
                                return (
                                    <div key={entry.id || idx} className="border-b border-gray-100 pb-1 last:border-b-0">
                                        <div className="text-[11px] text-gray-700">
                                            <span className="text-[10px] text-gray-400 mr-1">[{ts}]</span>
                                            <span className="font-semibold">{kindLabel}</span>
                                            <span className="mx-1 text-gray-400">|</span>
                                            <span className="text-gray-600 uppercase">{entry.action}</span>
                                            {entry.cardName && <span className="ml-1 text-gray-500">"{entry.cardName}"</span>}
                                            {entry.title && <span className="ml-1 text-gray-500">"{entry.title}"</span>}
                                        </div>
                                        {entry.changes && entry.changes.length > 0 && (
                                            <ul className="ml-3 mt-0.5 text-[10px] text-gray-500 space-y-0.5 list-disc">
                                                {entry.changes.map((ch, ci) => (
                                                    <li key={ci}>
                                                        <span className="font-mono text-gray-600">{ch.field}</span>
                                                        <span className="mx-1 text-gray-400">:</span>
                                                        {'before' in ch && ch.before !== undefined && ch.before !== null && String(ch.before) !== '' && (
                                                            <>
                                                                <span className="line-through text-red-400">{String(ch.before)}</span>
                                                                <span className="mx-1 text-gray-400">‚Üí</span>
                                                            </>
                                                        )}
                                                        <span className="text-green-600">{String(ch.after ?? '')}</span>
                                                    </li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}

                {showAddCard && (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full p-3 sm:p-4 md:p-6 max-h-[90vh] overflow-y-auto" style={{ maxWidth: 'min(700px, calc(100vw - 1rem))' }}>
                            <div className="flex justify-between mb-4"><h2 className="text-2xl font-bold">{editingCardId ? 'Editar' : 'Novo'} Card</h2><button onClick={()=>setShowAddCard(false)}>‚úï</button></div>
                            <CardForm 
                                initialData={editingCardId ? clients.find(c=>c.id===editingCardId) : uiState.newClient}
                                categories={boardState.categories} teamMembers={boardState.teamMembers} activityOptions={boardState.activityOptions} durationOptions={boardState.durationOptions}
                                onManageCategories={()=>setShowManageCategories(true)}
                                onManageMembers={()=>setShowManageMembers(true)}
                                onSave={(data) => {
                                    const nowIso = new Date().toISOString();
                                    const newData = { ...data, lastUpdated: nowIso };
                                    if(editingCardId) {
                                        const oldCard = clients.find(c => c.id === editingCardId) || {};
                                        const trackedFields = ['name','email','phone','category','assignedTo','address','activity','deadlineDate','deadlineTime','duration','rating','link','columnId','value'];
                                        const changes = [];
                                        trackedFields.forEach(field => {
                                            const before = oldCard[field];
                                            const after = newData[field];
                                            if (JSON.stringify(before) !== JSON.stringify(after)) {
                                                changes.push({ field, before, after });
                                            }
                                        });
                                        if (changes.length > 0) {
                                            addLogEntry({
                                                kind: 'card',
                                                action: 'edit',
                                                cardId: editingCardId,
                                                cardName: newData.name || oldCard.name || '',
                                                changes
                                            });
                                        }
                                        triggerSave({ clients: clients.map(c => c.id === editingCardId ? newData : c) });
                                    } else {
                                        if(!data.name) { notify("Preencha o Nome", 'error'); return; }
                                        const defaultColId = getDefaultColumnId();
                                        if (!newData.columnId && defaultColId) {
                                            newData.columnId = defaultColId;
                                        }
                                        if (!newData.columnId) {
                                            notify("√â necess√°rio ter pelo menos uma coluna para criar um card.", 'error');
                                            return;
                                        }
                                        const newId = uid();
                                        const createdAt = nowIso;
                                        const newClient = { id: newId, createdAt, ...newData };
                                        triggerSave({ clients: [...clients, newClient] });
                                        addLogEntry({
                                            kind: 'card',
                                            action: 'create',
                                            cardId: newId,
                                            cardName: newData.name,
                                            changes: [
                                                { field: 'coluna', before: '', after: boardState.columns[newData.columnId]?.title || newData.columnId }
                                            ]
                                        });
                                    }
                                    setShowAddCard(false);
                                }}
                                onDelete={() => requestConfirmation('Excluir', 'Tem certeza?', async () => {
                                    const card = clients.find(c=>c.id===editingCardId);
                                    setUndoStack({ type: 'card', data: card });
                                    if (card?.googleCalendarEventId) {
                                        const deleteFromCalendar = window.confirm('Excluir tamb√©m do Google Calendar?');
                                        if (deleteFromCalendar) {
                                            await deleteCalendarEvent(card.googleCalendarEventId);
                                        }
                                    }
                                    if (card) {
                                        const colTitle = boardState.columns[card.columnId]?.title || card.columnId;
                                        addLogEntry({
                                            kind: 'card',
                                            action: 'delete',
                                            cardId: card.id,
                                            cardName: card.name,
                                            changes: [
                                                { field: 'coluna', before: colTitle, after: '' }
                                            ]
                                        });
                                    }
                                    triggerSave({ clients: clients.filter(c => c.id !== editingCardId) });
                                    setShowAddCard(false);
                                })}
                            />
                        </div>
                    </div>
                )}
                
                {showAddCategory && <SimpleModal title="Nova Categoria" onClose={()=>setShowAddCategory(false)} onSave={v => triggerSave({ board: {...boardState, categories: [...boardState.categories, v]} })} />}
                {showManageCategories && <ManageItemsModal title="Gerenciar Categorias" items={boardState.categories} onClose={()=>setShowManageCategories(false)} onSave={(items) => triggerSave({ board: {...boardState, categories: items} })} />}
                {showManageMembers && <ManageItemsModal title="Gerenciar Respons√°veis" items={boardState.teamMembers} onClose={()=>setShowManageMembers(false)} onSave={(items) => triggerSave({ board: {...boardState, teamMembers: items} })} />}
                {showCalendarGuide && <GoogleCalendarGuideModal onClose={()=>setShowCalendarGuide(false)} />}
                {isAddingColumn && <SimpleModal title="Nova Coluna" onClose={()=>setIsAddingColumn(false)} onSave={v => { const id=v.toLowerCase().replace(/\s/g,'-'); triggerSave({ board: {...boardState, columns: {...boardState.columns, [id]:{id, title:v}}, columnOrder: [...boardState.columnOrder, id]} }); addLogEntry({ kind: 'column', action: 'create', columnId: id, title: v }); }} />}
            </div>
        );
      }

      // --- UI COMPONENTS ---
      function SimpleModal({ title, onClose, onSave }) {
          const [val, setVal] = useState('');
          return <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div className="bg-white p-6 rounded w-80"><h3 className="font-bold mb-2">{title}</h3><input className="border p-2 w-full mb-4" value={val} onChange={e=>setVal(e.target.value)}/><div className="flex justify-end gap-2"><button onClick={onClose} className="px-3 bg-gray-200 rounded">Cancelar</button><button onClick={()=>{if(val) {onSave(val); onClose();}}} className="px-3 bg-blue-600 text-white rounded">Salvar</button></div></div></div>;
      }

      function ManageItemsModal({ title, items, onClose, onSave }) {
          const [localItems, setLocalItems] = useState([...items]);
          const [newItem, setNewItem] = useState('');
          const [editingIndex, setEditingIndex] = useState(null);
          const [editingValue, setEditingValue] = useState('');

          const handleAdd = () => {
              if (newItem.trim() && !localItems.includes(newItem.trim())) {
                  setLocalItems([...localItems, newItem.trim()]);
                  setNewItem('');
              }
          };

          const handleEdit = (index) => {
              setEditingIndex(index);
              setEditingValue(localItems[index]);
          };

          const handleSaveEdit = () => {
              if (editingValue.trim() && editingIndex !== null) {
                  const updated = [...localItems];
                  updated[editingIndex] = editingValue.trim();
                  setLocalItems(updated);
                  setEditingIndex(null);
                  setEditingValue('');
              }
          };

          const handleDelete = (index) => {
              if (window.confirm(`Tem certeza que deseja excluir "${localItems[index]}"?`)) {
                  setLocalItems(localItems.filter((_, i) => i !== index));
              }
          };

          const handleSave = () => {
              onSave(localItems);
              onClose();
          };

          return (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                  <div className="bg-white p-6 rounded-lg w-full max-w-md max-h-[80vh] overflow-y-auto">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-xl font-bold">{title}</h3>
                          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                      </div>
                      
                      {/* Adicionar novo item */}
                      <div className="mb-4 flex gap-2">
                          <input 
                              className="flex-1 border p-2 rounded" 
                              placeholder="Novo item..." 
                              value={newItem} 
                              onChange={e=>setNewItem(e.target.value)}
                              onKeyPress={e=>{if(e.key==='Enter') handleAdd();}}
                          />
                          <button onClick={handleAdd} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">+</button>
                      </div>

                      {/* Lista de itens */}
                      <div className="space-y-2 mb-4 max-h-64 overflow-y-auto">
                          {localItems.length === 0 ? (
                              <p className="text-gray-500 text-center py-4">Nenhum item cadastrado</p>
                          ) : (
                              localItems.map((item, index) => (
                                  <div key={index} className="flex items-center gap-2 p-2 border rounded hover:bg-gray-50">
                                      {editingIndex === index ? (
                                          <>
                                              <input 
                                                  className="flex-1 border p-1 rounded" 
                                                  value={editingValue} 
                                                  onChange={e=>setEditingValue(e.target.value)}
                                                  onKeyPress={e=>{if(e.key==='Enter') handleSaveEdit(); if(e.key==='Escape') {setEditingIndex(null); setEditingValue('');}}}
                                                  autoFocus
                                              />
                                              <button onClick={handleSaveEdit} className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">‚úì</button>
                                              <button onClick={()=>{setEditingIndex(null); setEditingValue('');}} className="px-3 py-1 bg-gray-400 text-white rounded text-sm hover:bg-gray-500">‚úï</button>
                                          </>
                                      ) : (
                                          <>
                                              <span className="flex-1">{item}</span>
                                              <button onClick={()=>handleEdit(index)} className="px-3 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600">‚úèÔ∏è</button>
                                              <button onClick={()=>handleDelete(index)} className="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">üóëÔ∏è</button>
                                          </>
                                      )}
                                  </div>
                              ))
                          )}
                      </div>

                      {/* Bot√µes de a√ß√£o */}
                      <div className="flex justify-end gap-2 pt-4 border-t">
                          <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
                          <button onClick={handleSave} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Salvar</button>
                      </div>
                  </div>
              </div>
          );
      }

      function GoogleCalendarGuideModal({ onClose }) {
          return (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl">
                      <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                          <h2 className="text-2xl font-bold text-gray-800">üìñ Guia: Configurar Google Calendar (dom√≠nio)</h2>
                          <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-3xl leading-none">√ó</button>
                      </div>
                      
                      <div className="p-6 space-y-6">
                          {/* Introdu√ß√£o */}
                          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                              <h3 className="font-bold text-lg mb-2 text-blue-800">‚ú® √â 100% GRATUITO!</h3>
                              <p className="text-blue-700">
                                  A API do Google Calendar oferece <strong>1.000.000 de requisi√ß√µes por dia gratuitamente</strong>, 
                                  mais que suficiente para uso pessoal e de pequenas equipes.
                              </p>
                          </div>

                          {/* Passo 1 */}
                          <div className="border rounded-lg p-5 bg-gray-50">
                              <div className="flex items-center gap-3 mb-3">
                                  <span className="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">1</span>
                                  <h3 className="text-xl font-bold">Criar um Projeto no Google Cloud Platform</h3>
                              </div>
                              <ol className="list-decimal list-inside space-y-2 ml-11 text-gray-700">
                                  <li>Acesse <a href="https://console.cloud.google.com" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline font-semibold">console.cloud.google.com</a></li>
                                  <li>Fa√ßa login com sua conta Google</li>
                                  <li>No canto superior, clique no seletor de projetos</li>
                                  <li>Clique em <strong>"Novo Projeto"</strong></li>
                                  <li>Digite um nome (ex: "Meu Kanban Calendar")</li>
                                  <li>Clique em <strong>"Criar"</strong></li>
                                  <li>Aguarde alguns segundos e selecione o projeto criado</li>
                              </ol>
                          </div>

                          {/* Passo 2 */}
                          <div className="border rounded-lg p-5 bg-gray-50">
                              <div className="flex items-center gap-3 mb-3">
                                  <span className="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">2</span>
                                  <h3 className="text-xl font-bold">Habilitar a API do Google Calendar</h3>
                              </div>
                              <ol className="list-decimal list-inside space-y-2 ml-11 text-gray-700">
                                  <li>No menu lateral, v√° em <strong>"APIs e Servi√ßos"</strong> ‚Üí <strong>"Biblioteca"</strong></li>
                                  <li>Na busca, digite: <strong>"Google Calendar API"</strong></li>
                                  <li>Clique no resultado <strong>"Google Calendar API"</strong></li>
                                  <li>Clique no bot√£o <strong>"ATIVAR"</strong> (pode levar alguns segundos)</li>
                                  <li>Aguarde a confirma√ß√£o de que a API foi ativada</li>
                              </ol>
                          </div>

                          {/* Passo 3 */}
                          <div className="border rounded-lg p-5 bg-gray-50">
                              <div className="flex items-center gap-3 mb-3">
                                  <span className="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">3</span>
                                  <h3 className="text-xl font-bold">Configurar Tela de Consentimento OAuth</h3>
                              </div>
                              <ol className="list-decimal list-inside space-y-2 ml-11 text-gray-700">
                                  <li>No menu lateral, v√° em <strong>"APIs e Servi√ßos"</strong> ‚Üí <strong>"Tela de consentimento OAuth"</strong></li>
                                  <li>Selecione <strong>"Externo"</strong> e clique em <strong>"Criar"</strong></li>
                                  <li>Preencha os campos obrigat√≥rios:
                                      <ul className="list-disc list-inside ml-6 mt-2 space-y-1">
                                          <li><strong>Nome do app:</strong> "Meu Kanban" (ou qualquer nome)</li>
                                          <li><strong>Email de suporte do usu√°rio:</strong> Seu email</li>
                                          <li><strong>Email de contato do desenvolvedor:</strong> Seu email</li>
                                      </ul>
                                  </li>
                                  <li>Clique em <strong>"Salvar e continuar"</strong> nas pr√≥ximas telas (pode pular as opcionais)</li>
                                  <li>Na √∫ltima tela, clique em <strong>"Voltar ao painel"</strong></li>
                              </ol>
                          </div>

                          {/* Passo 4 */}
                          <div className="border rounded-lg p-5 bg-gray-50">
                              <div className="flex items-center gap-3 mb-3">
                                  <span className="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">4</span>
                                  <h3 className="text-xl font-bold">Criar Credenciais OAuth 2.0</h3>
                              </div>
                              <ol className="list-decimal list-inside space-y-2 ml-11 text-gray-700">
                                  <li>No menu lateral, v√° em <strong>"APIs e Servi√ßos"</strong> ‚Üí <strong>"Credenciais"</strong></li>
                                  <li>Clique em <strong>"+ CRIAR CREDENCIAIS"</strong> ‚Üí <strong>"ID do cliente OAuth"</strong></li>
                                  <li>Selecione <strong>"Aplicativo da Web"</strong> como tipo</li>
                                  <li>D√™ um nome (ex: "Kanban Web Client")</li>
                                  <li>Em <strong>"Origens JavaScript autorizadas"</strong>, adicione apenas o dom√≠nio publicado:
                                      <ul className="list-disc list-inside ml-6 mt-2 space-y-1 bg-yellow-50 p-2 rounded">
                                          <li><code className="bg-gray-200 px-1 rounded">https://viniciusrodriguesgithub.github.io</code></li>
                                      </ul>
                                  </li>
                                  <li>Em <strong>"URIs de redirecionamento autorizados"</strong>, adicione o mesmo dom√≠nio:
                                      <ul className="list-disc list-inside ml-6 mt-2 space-y-1 bg-yellow-50 p-2 rounded">
                                          <li><code className="bg-gray-200 px-1 rounded">https://viniciusrodriguesgithub.github.io</code></li>
                                      </ul>
                                  </li>
                                  <li>Clique em <strong>"Criar"</strong></li>
                                  <li><strong>IMPORTANTE:</strong> Copie o <strong>"ID do cliente"</strong> que aparece (algo como: <code className="bg-gray-200 px-1 rounded">xxxxx.apps.googleusercontent.com</code>)</li>
                              </ol>
                          </div>

                          {/* Passo 5 */}
                          <div className="border rounded-lg p-5 bg-green-50 border-green-500">
                              <div className="flex items-center gap-3 mb-3">
                                  <span className="bg-green-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">5</span>
                                  <h3 className="text-xl font-bold text-green-800">Usar no Pepper Hat</h3>
                              </div>
                              <ol className="list-decimal list-inside space-y-2 ml-11 text-green-700">
                                  <li>Feche este guia</li>
                                  <li>No menu <strong>"Op√ß√µes"</strong>, clique em <strong>"üìÖ Conectar Google Calendar"</strong></li>
                                  <li>Uma janela do Google abrir√° pedindo permiss√£o</li>
                                  <li>Selecione sua conta Google</li>
                                  <li>Clique em <strong>"Permitir"</strong> para dar acesso ao calend√°rio</li>
                                  <li>Pronto! Agora voc√™ pode sincronizar seus cards com prazo</li>
                              </ol>
                          </div>

                          {/* Dicas */}
                          <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                              <h3 className="font-bold text-lg mb-2 text-yellow-800">üí° Dicas Importantes:</h3>
                              <ul className="list-disc list-inside space-y-1 text-yellow-700">
                                  <li>O limite gratuito √© de <strong>1 milh√£o de requisi√ß√µes por dia</strong> - mais que suficiente!</li>
                                  <li>Os eventos s√£o criados no seu calend√°rio principal do Google</li>
                                  <li>Voc√™ pode editar/excluir eventos diretamente no Google Calendar</li>
                                  <li>Se atualizar um card aqui, sincronize novamente para atualizar o evento</li>
                                  <li>Cards sem prazo (deadlineDate) n√£o ser√£o sincronizados</li>
                              </ul>
                          </div>

                          {/* Links √∫teis */}
                          <div className="bg-gray-100 p-4 rounded">
                              <h3 className="font-bold mb-2">üîó Links √öteis:</h3>
                              <ul className="space-y-1 text-sm">
                                  <li>‚Ä¢ <a href="https://console.cloud.google.com" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">Google Cloud Console</a></li>
                                  <li>‚Ä¢ <a href="https://developers.google.com/calendar/api/guides/overview" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">Documenta√ß√£o da API</a></li>
                                  <li>‚Ä¢ <a href="https://developers.google.com/identity/protocols/oauth2" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">Guia OAuth 2.0</a></li>
                              </ul>
                          </div>

                          {/* Bot√£o fechar */}
                          <div className="flex justify-end pt-4 border-t">
                              <button onClick={onClose} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                                  Entendi! Fechar Guia
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
          );
      }

      // Fun√ß√£o reus√°vel para criar reconhecimento de voz com press and hold
      function createVoiceRecognitionHandler(onResult, onError) {
          if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
              return null;
          }

          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const recognition = new SpeechRecognition();
          recognition.lang = 'pt-BR';
          recognition.continuous = false;
          recognition.interimResults = false;

          recognition.onresult = function(event) {
              const transcript = event.results[0][0].transcript;
              if (onResult) {
                  onResult(transcript);
              }
          };

          recognition.onerror = function(event) {
              if (onError) {
                  onError('Erro: ' + event.error);
              }
          };

          recognition.onend = function() {
              // Reconhecimento finalizado
          };

          return recognition;
      }

      function CardForm({ initialData, categories, teamMembers, activityOptions, durationOptions, onSave, onDelete, onManageCategories = () => {}, onManageMembers = () => {} }) {
          const [formData, setFormData] = useState(initialData);
          const [note, setNote] = useState('');
          const recognitionRefs = useRef({});
          const pressTimers = useRef({});
          const h = (f,v) => setFormData(p => ({...p, [f]: v}));
          
          // Fun√ß√£o para criar handlers de press and hold para um campo
          const createVoiceHandlers = (fieldName, updateFn) => {
              if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                  return null;
              }

              const recognition = createVoiceRecognitionHandler(
                  (transcript) => {
                      updateFn(transcript);
                  },
                  (error) => {
                      console.error(error);
                  }
              );

              if (!recognition) return null;

              recognitionRefs.current[fieldName] = recognition;

              const handlePressStart = (e) => {
                  // N√£o previne comportamento padr√£o para n√£o interferir com digita√ß√£o normal
                  // Inicia timer - ap√≥s 300ms de press√£o cont√≠nua, ativa o reconhecimento
                  pressTimers.current[fieldName] = setTimeout(() => {
                      try {
                          recognition.start();
                          if (e.target) {
                              e.target.style.borderColor = '#ef4444';
                              e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.3)';
                          }
                      } catch (err) {
                          console.error('Erro ao iniciar reconhecimento:', err);
                      }
                  }, 300);
              };

              const handlePressEnd = (e) => {
                  // Cancela timer se soltou antes de 300ms
                  if (pressTimers.current[fieldName]) {
                      clearTimeout(pressTimers.current[fieldName]);
                      delete pressTimers.current[fieldName];
                  }
                  
                  // Para o reconhecimento se estiver ativo
                  try {
                      if (recognitionRefs.current[fieldName]) {
                          recognitionRefs.current[fieldName].stop();
                      }
                  } catch (err) {}
                  
                  // Restaura estilo visual
                  if (e.target) {
                      e.target.style.borderColor = '';
                      e.target.style.boxShadow = '';
                  }
              };

              return {
                  onMouseDown: handlePressStart,
                  onMouseUp: handlePressEnd,
                  onMouseLeave: handlePressEnd,
                  onTouchStart: handlePressStart,
                  onTouchEnd: handlePressEnd,
                  onTouchCancel: handlePressEnd
              };
          };

          // Handlers para cada campo
          const nameHandlers = createVoiceHandlers('name', (text) => h('name', text));
          const emailHandlers = createVoiceHandlers('email', (text) => h('email', text));
          const phoneHandlers = createVoiceHandlers('phone', (text) => h('phone', text));
          const addressHandlers = createVoiceHandlers('address', (text) => h('address', text));
          const linkHandlers = createVoiceHandlers('link', (text) => h('link', text));
          const noteHandlers = createVoiceHandlers('note', (text) => setNote(text));

          // Limpeza ao desmontar
          useEffect(() => {
              return () => {
                  Object.values(recognitionRefs.current).forEach(rec => {
                      try { rec.stop(); } catch(e) {}
                  });
                  Object.values(pressTimers.current).forEach(timer => {
                      clearTimeout(timer);
                  });
              };
          }, []);
          return (
              <form onSubmit={e => { e.preventDefault(); onSave(formData); }}>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 mb-4" style={{ minWidth: 0 }}>
                      <div className="col-span-1 md:col-span-2" style={{ minWidth: 0 }}>
                          <label className="text-xs font-bold text-gray-500">ü™™NOME</label>
                          <input 
                              className="w-full border-2 border-blue-500 p-2 rounded" 
                              value={formData.name} 
                              onChange={e=>h('name',e.target.value)}
                              {...(nameHandlers || {})}
                              required 
                              style={{ minWidth: 0 }}
                          />
                      </div>
                      <div style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">üìßEMAIL</label><input className="w-full border-2 border-blue-500 p-2 rounded" value={formData.email} onChange={e=>h('email',e.target.value)} {...(emailHandlers || {})} style={{ minWidth: 0 }} /></div>
                      <div style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">üìûTELEFONE</label><input className="w-full border-2 border-blue-500 p-2 rounded" value={formData.phone} onChange={e=>h('phone',e.target.value)} {...(phoneHandlers || {})} style={{ minWidth: 0 }} /></div>
                      <div style={{ minWidth: 0 }}>
                          <div className="flex items-center justify-between">
                              <label className="text-xs font-bold text-gray-500">üîΩCATEGORIA</label>
                              <button type="button" onClick={onManageCategories} className="text-[10px] text-blue-600 hover:underline">Gerenciar</button>
                          </div>
                          <select className="w-full border p-2 rounded" value={formData.category} onChange={e=>h('category',e.target.value)} style={{ minWidth: 0 }}><option value="">-</option>{categories.map(c=><option key={c} value={c}>{c}</option>)}</select>
                      </div>
                      <div style={{ minWidth: 0 }}>
                          <div className="flex items-center justify-between">
                              <label className="text-xs font-bold text-gray-500">üë§RESPONS√ÅVEL</label>
                              <button type="button" onClick={onManageMembers} className="text-[10px] text-blue-600 hover:underline">Gerenciar</button>
                          </div>
                          <select className="w-full border p-2 rounded" value={formData.assignedTo} onChange={e=>h('assignedTo',e.target.value)} style={{ minWidth: 0 }}><option value="">-</option>{teamMembers.map(m=><option key={m} value={m}>{m}</option>)}</select>
                      </div>
                      
                      <div className="col-span-1 md:col-span-2" style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">ENDERE√áO</label><input className="w-full border-2 border-blue-500 p-2 rounded" value={formData.address} onChange={e=>h('address',e.target.value)} {...(addressHandlers || {})} style={{ minWidth: 0 }} /></div>
                      
                      <div style={{ minWidth: 0 }}>
                          <label className="text-xs font-bold text-gray-500">ATIVIDADE</label>
                          <div className="flex gap-2 mt-1">
                              <button 
                                  type="button"
                                  onClick={() => h('activity', formData.activity === 'Interna' ? '' : 'Interna')}
                                  className={`flex-1 px-3 py-2 rounded border-2 transition-all text-sm font-medium ${
                                      formData.activity === 'Interna' 
                                          ? 'text-white shadow-md' 
                                          : 'bg-white text-gray-700 border-gray-300 hover:border-pink-400 hover:bg-pink-50'
                                  }`}
                                  style={formData.activity === 'Interna' ? { backgroundColor: '#ec4899', borderColor: '#db2777' } : {}}
                              >
                                  üè† Interna
                              </button>
                              <button 
                                  type="button"
                                  onClick={() => h('activity', formData.activity === 'Externa' ? '' : 'Externa')}
                                  className={`flex-1 px-3 py-2 rounded border-2 transition-all text-sm font-medium ${
                                      formData.activity === 'Externa' 
                                          ? 'text-white shadow-md' 
                                          : 'bg-white text-gray-700 border-gray-300 hover:border-pink-400 hover:bg-pink-50'
                                  }`}
                                  style={formData.activity === 'Externa' ? { backgroundColor: '#ec4899', borderColor: '#db2777' } : {}}
                              >
                                  üöó Externa
                              </button>
                              <button 
                                  type="button"
                                  onClick={() => h('activity', formData.activity === 'Digital' ? '' : 'Digital')}
                                  className={`flex-1 px-3 py-2 rounded border-2 transition-all text-sm font-medium ${
                                      formData.activity === 'Digital' 
                                          ? 'text-white shadow-md' 
                                          : 'bg-white text-gray-700 border-gray-300 hover:border-pink-400 hover:bg-pink-50'
                                  }`}
                                  style={formData.activity === 'Digital' ? { backgroundColor: '#ec4899', borderColor: '#db2777' } : {}}
                              >
                                  üì± Digital
                              </button>
                          </div>
                      </div>
                      <div style={{ minWidth: 0 }}>
                          <label className="text-xs font-bold text-gray-500">DURA√á√ÉO <span className="text-gray-400 font-normal">(tempo estimado)</span></label>
                          <div className="grid grid-cols-2 gap-2 mt-1">
                              {['Minutos', 'Horas', 'Dia', 'Dias'].map(d => {
                                  const colorMap = {
                                      'Minutos': '#31c86e',
                                      'Horas': '#e5b720',
                                      'Dia': '#478bf7',
                                      'Dias': '#121619'
                                  };
                                  const selectedColor = colorMap[d];
                                  return (
                                      <button
                                          key={d}
                                          type="button"
                                          onClick={() => h('duration', formData.duration === d ? '' : d)}
                                          className={`px-3 py-2 rounded border-2 transition-all text-xs font-medium ${
                                              formData.duration === d
                                                  ? 'text-white shadow-md'
                                                  : 'bg-white text-gray-700 border-gray-300'
                                          }`}
                                          style={formData.duration === d ? { 
                                              backgroundColor: selectedColor, 
                                              borderColor: selectedColor 
                                          } : {}}
                                      >
                                          {d}
                                      </button>
                                  );
                              })}
                          </div>
                      </div>
                      
                      <div style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">üìÖPRAZO DATA</label><input type="date" className="w-full border p-2 rounded" value={formData.deadlineDate} onChange={e=>h('deadlineDate',e.target.value)} style={{ minWidth: 0 }} /></div>
                      <div style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">‚è±Ô∏èPRAZO HORA</label><input type="time" className="w-full border p-2 rounded" value={formData.deadlineTime} onChange={e=>h('deadlineTime',e.target.value)} style={{ minWidth: 0 }} /></div>
                      
                      <div style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">üîóLINK</label><input className="w-full border-2 border-blue-500 p-2 rounded" value={formData.link} onChange={e=>h('link',e.target.value)} {...(linkHandlers || {})} style={{ minWidth: 0 }} /></div>
                      <div style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">üí≤VALOR</label><input type="text" className="w-full border-2 border-blue-500 p-2 rounded" value={formData.value ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(formData.value) : 'R$ 0,00'} onChange={e=>{const val=e.target.value.replace(/[^\d,]/g,'').replace(',','.'); h('value',val?parseFloat(val):0);}} style={{ minWidth: 0 }} /></div>
                      <div className="col-span-1 md:col-span-2" style={{ minWidth: 0 }}><label className="text-xs font-bold text-gray-500">AVALIA√á√ÉO</label><div className="flex gap-1">{[1,2,3,4,5].map(s=><button type="button" key={s} onClick={()=>h('rating',s)} className={`text-xl ${s<=(formData.rating||0)?'text-yellow-400':'text-gray-300'}`}>‚òÖ</button>)}</div></div>
                  </div>
                    <div className="bg-gray-50 p-3 rounded border mb-4" style={{ minWidth: 0 }}>
                    <label className="text-xs font-bold text-gray-500">‚úèÔ∏èANOTA√á√ïES</label>
                    <div className="h-24 overflow-y-auto mb-2 text-sm space-y-1">
                      {(formData.notes||[]).map((n,i)=>{
                        let prefix = '';
                        if (n.timestamp) {
                          const d = new Date(n.timestamp);
                          if (!isNaN(d.getTime())) {
                            const dia   = String(d.getDate()).padStart(2,'0');
                            const mes   = String(d.getMonth()+1).padStart(2,'0');
                            const hora  = String(d.getHours()).padStart(2,'0');
                            const min   = String(d.getMinutes()).padStart(2,'0');
                            prefix = `${dia}/${mes} ${hora}:${min} ¬∑ `;
                          }
                        }
                        const handleDeleteNote = (e) => {
                          e.stopPropagation();
                          if (confirm('Tem certeza que deseja excluir esta anota√ß√£o?')) {
                            const newNotes = (formData.notes || []).filter((_, idx) => idx !== i);
                            h('notes', newNotes);
                          }
                        };
                        return (
                          <div key={i} className="bg-white p-1 rounded border flex items-start justify-between gap-1">
                            <div className="flex-1">
                              {prefix && <span className="text-[10px] text-gray-400 font-mono mr-1">{prefix}</span>}
                              <span>{n.text}</span>
                            </div>
                            <button
                              type="button"
                              onClick={handleDeleteNote}
                              className="ml-1 text-[10px] text-red-400 hover:text-red-600 flex-shrink-0"
                              title="Excluir anota√ß√£o"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        );
                      })}
                    </div>
                     <div className="flex gap-2" style={{ minWidth: 0 }}>
                       <input
                         className="flex-grow border-2 border-blue-500 p-1 rounded min-w-0"
                         value={note}
                         onChange={e=>setNote(e.target.value)}
                         {...(noteHandlers || {})}
                         style={{ minWidth: 0 }}
                       />
                       <button
                         type="button"
                         onClick={()=>{
                           if(note.trim()){
                             h('notes', [...(formData.notes||[]), {text:note.trim(), timestamp:new Date().toISOString()}]);
                             setNote('');
                           }
                         }}
                         className="px-3 bg-blue-100 text-blue-700 rounded flex-shrink-0 text-xs"
                       >
                         Add
                       </button>
                     </div>
                     </div>
                  <div className="flex justify-between border-t pt-4">
                      {initialData.id && <button type="button" onClick={onDelete} className="text-red-500 font-bold">Excluir</button>}
                      <button className="px-6 py-2 bg-purple-600 text-white font-bold rounded shadow ml-auto">Salvar</button>
                  </div>
              </form>
          );
      }

      function Card({ card, compact, disablePulsing, onDragStart, onFileDrop, onClick }) {
          const [hover, setHover] = useState(false);
          const showDetails = !compact || hover;
          
          // Logic for borders & inactivity
          const now = new Date();
          const lastUpdated = new Date(card.lastUpdated || card.createdAt);
          const diffTime = Math.abs(now - lastUpdated);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
          const isInactive = diffDays > 7;
          const isRecent = diffTime < (48 * 60 * 60 * 1000);

          const getTailwindColor = (colorName) => {
            switch (colorName) {
                case 'green-500': return 'rgb(34, 197, 94)';
                case 'yellow-500': return 'rgb(234, 179, 8)';
                case 'blue-500': return 'rgb(59, 130, 246)';
                case 'black': return 'rgb(0, 0, 0)';
                case 'red-400': return 'rgb(248, 113, 113)';
                default: return 'transparent';
            }
          };

          let leftBorderColor = 'transparent';
          // CORRE√á√ÉO: Ordem de prioridade. Dura√ß√£o > Inativo.
          if (card.duration === 'Minutos') leftBorderColor = getTailwindColor('green-500');
          else if (card.duration === 'Horas') leftBorderColor = getTailwindColor('yellow-500');
          else if (card.duration === 'Dia') leftBorderColor = getTailwindColor('blue-500');
          else if (card.duration === 'Dias') leftBorderColor = getTailwindColor('black');
          else if (isInactive) leftBorderColor = getTailwindColor('red-400');

          // Right border (Aging)
          const createdAtDate = new Date(card.createdAt);
          const timeSinceCreation = now - createdAtDate.getTime();
          const maxAgeMs = 168 * 60 * 60 * 1000; // 7 dias

          let rightBorderColor = 'transparent';
          if (timeSinceCreation < maxAgeMs) {
            const factor = timeSinceCreation / maxAgeMs;
            // Interpolate Pink (#ff86a5) to Purple (#260038)
            const startR = 255, startG = 134, startB = 165; 
            const endR = 38, endG = 0, endB = 56;
            const cR = Math.round(startR + (endR - startR) * factor);
            const cG = Math.round(startG + (endG - startG) * factor);
            const cB = Math.round(startB + (endB - startB) * factor);
            rightBorderColor = `rgb(${cR}, ${cG}, ${cB})`;
          }

          const customBoxShadow = [
            leftBorderColor !== 'transparent' ? `inset 4px 0 0 0 ${leftBorderColor}` : '',
            rightBorderColor !== 'transparent' ? `inset -4px 0 0 0 ${rightBorderColor}` : '',
          ].filter(Boolean).join(', ');

          // Pulsing
          let pulseDuration = '0s';
          let pulsingGreenColor = '#e4fac9';
          if (isRecent && card.isPulsing !== false && !disablePulsing) {
               const normalizedTime = (Date.now() - new Date(card.lastUpdated).getTime()) / (48 * 60 * 60 * 1000);
               pulseDuration = `${0.5 + (normalizedTime * 1.5)}s`;
               // Green to Lilac interpolation logic...
               const startR = 184, startG = 238, startB = 184; 
               const endR = 221, endG = 190, endB = 221;
               const cR = Math.round(startR + (endR - startR) * normalizedTime);
               const cG = Math.round(startG + (endG - startG) * normalizedTime);
               const cB = Math.round(startB + (endB - startB) * normalizedTime);
               pulsingGreenColor = `rgb(${cR}, ${cG}, ${cB})`;
          }
          
          // CORRE√á√ÉO: Opacidade baseada em rating
          const cardOpacity = card.rating === 0 ? 0.6 : (0.5 + (card.rating / 10)); 

          return (
              <div draggable onDragStart={e => onDragStart(e, card.id)} onClick={onClick} 
                   onMouseEnter={()=>setHover(true)} onMouseLeave={()=>setHover(false)}
                   onDragOver={e=>e.preventDefault()} onDrop={e=>onFileDrop(e, card.id)}
                   className={`bg-white p-3 rounded shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition-all ${isRecent && !disablePulsing ? 'pulsing-green' : ''}`}
                   style={{ 
                       opacity: cardOpacity,
                       boxShadow: customBoxShadow,
                       '--card-bg-color': (card.notes && card.notes.length > 0) ? '#FFFACD' : 'white',
                       '--pulse-green-color': pulsingGreenColor,
                       backgroundColor: (card.notes && card.notes.length > 0) ? '#FFFACD' : 'white',
                       animationDuration: pulseDuration
                   }}
                   title={(card.notes || []).map(n => n.text).join('\n')}>
                  
                  <div className="flex justify-between items-start mb-1">
                      <div className="font-bold text-gray-800 text-sm leading-tight flex flex-wrap items-center gap-0.5">
                          {/* Emoji Activities */}
                          {card.activity === 'Interna' && <span title="Atividade: Interna">üè†</span>}
                          {card.activity === 'Externa' && <span title="Atividade: Externa">üöó</span>}
                          {card.activity === 'Digital' && <span title="Atividade: Digital">üì±</span>}
                          
                          {/* Emoji Categories (only if not activity) */}
                          {!card.activity && card.category === 'Cerimonialista' && <span title="Categoria: Cerimonialista">üíê</span>}
                          {!card.activity && card.category === 'Hotel' && <span title="Categoria: Hotel">üè®</span>}
                          {!card.activity && card.category === 'Teatro' && <span title="Categoria: Teatro">üé≠</span>}
                          {!card.activity && card.category === 'Eventos' && <span title="Categoria: Eventos">üçæ</span>}
                          {!card.activity && card.category === 'Corporativo' && <span title="Categoria: Corporativo">üëî</span>}    
                          {!card.activity && card.category === 'Setor P√∫blico' && <span title="Categoria: Setor P√∫blico">üèõÔ∏è</span>}
                          {!card.activity && card.category === 'Servi√ßo Social' && <span title="Categoria: Servi√ßo Social">üåé</span>}

                          {/* Name */}
                          <span>{card.name}</span>
                          
                          {/* Star after name */}
                          {card.rating === 5 && <span className="ml-1" title="Classifica√ß√£o: 5 estrelas">‚≠ê</span>}
                      </div>
                      {card.deadlineDate && (
                          <div className="text-[10px] font-mono text-red-600 bg-transparent px-1 rounded ml-1 whitespace-nowrap">
                              {(() => {
                                const deadline = new Date(card.deadlineDate + (card.deadlineTime ? `T${card.deadlineTime}` : 'T00:00:00'));
                                const now = new Date();
                                const diffTime = deadline.getTime() - now.getTime();
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                
                                if (diffTime < 0) return deadline.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                                if (diffDays >= 7) return deadline.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', weekday: 'short' }).replace(', ', ' ');
                                if (diffDays > 1) return `${diffDays}d`;
                                if (diffDays === 1) {
                                    const hrs = Math.floor(diffTime / 1000 / 60 / 60);
                                    return hrs > 0 ? `${hrs}h` : "AGORA";
                                }
                                return null;
                              })()}
                          </div>
                      )}
                  </div>

                  {showDetails && (
                      <div className="mt-2 space-y-1">
                          <div className="text-xs text-gray-500 flex flex-wrap gap-1">
                              {card.email && <span title={card.email}>‚úâÔ∏è</span>}
                              {card.phone && <span title={card.phone} onClick={(e) => { e.stopPropagation(); window.open(`https://api.whatsapp.com/send?phone=${card.phone.replace(/\D/g, '')}`); }}>üìû</span>}
                              {card.address && <span title={card.address} onClick={(e) => { e.stopPropagation(); window.open(`https://maps.google.com/?q=${card.address}`); }}>üìç</span>}
                              {card.link && <span title={card.link} onClick={(e) => { e.stopPropagation(); window.open(card.link); }}>üîó</span>}
                          </div>
                          {/* Removed Responsible and Rating from Card Body as requested */}
                          {/* {card.category && <div className="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded inline-block">{card.category}</div>} */}
                      </div>
                  )}
                  {isInactive && !card.duration && <div className="mt-1 text-[10px] text-red-500 font-bold">Inativo por {diffDays} dias</div>}
              </div>
          );
      }

      function CalendarDisplay({ clients, view, selectedDate, setSelectedDate, setEditingCardId, filters }) {
        const daysInMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate();
        const startDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getDay();
        const days = Array(startDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));
        
        const filtered = clients.filter(c => 
            (!filters.searchTerm || c.name.toLowerCase().includes(filters.searchTerm.toLowerCase())) &&
            (!filters.filterCategory || c.category === filters.filterCategory)
        );

        return (
            <div className="bg-white p-6 rounded shadow h-full overflow-auto">
                <div className="flex justify-between mb-4">
                    <h2 className="text-2xl font-bold">{view === 'calendar' ? 'Calend√°rio' : 'Lista'}</h2>
                    <div className="flex gap-2">
                        <button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()-1)))} className="p-2 bg-gray-100 rounded">‚óÄ</button>
                        <span className="w-32 text-center font-bold pt-2">{selectedDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'})}</span>
                        <button onClick={()=>setSelectedDate(new Date(selectedDate.setMonth(selectedDate.getMonth()+1)))} className="p-2 hover:bg-white rounded">‚ñ∂</button>
                    </div>
                </div>
                {view === 'calendar' ? (
                    <div className="grid grid-cols-7 gap-px bg-gray-200 border rounded">
                        {['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'].map(d=><div key={d} className="bg-gray-50 p-2 text-center font-bold text-xs">{d}</div>)}
                        {days.map((d,i) => (
                            <div key={i} className={`bg-white min-h-[80px] p-1 ${!d?'bg-gray-50':''}`}>
                                {d && (
                                    <>
                                        <div className="text-right text-xs text-gray-400 font-bold mb-1">{d}</div>
                                        <div className="space-y-1 overflow-y-auto max-h-20">
                                            {filtered.filter(c => c.deadlineDate && new Date(c.deadlineDate).getDate() === d && new Date(c.deadlineDate).getMonth() === selectedDate.getMonth()).map(c => (
                                                <div key={c.id} onClick={()=>setEditingCardId(c.id)} className="text-[10px] bg-blue-100 text-blue-800 p-1 rounded truncate cursor-pointer hover:bg-blue-200">
                                                    {c.deadlineTime} {c.name}
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="space-y-2">
                        {filtered.filter(c=>c.deadlineDate).sort((a,b)=>new Date(a.deadlineDate)-new Date(b.deadlineDate)).map(c => (
                            <div key={c.id} onClick={()=>setEditingCardId(c.id)} className="flex items-center gap-4 p-3 border rounded hover:bg-gray-50 cursor-pointer">
                                <div className="w-20 text-center font-bold text-purple-600">{new Date(c.deadlineDate).toLocaleDateString()}</div>
                                <div className="flex-grow font-bold">{c.name}</div>
                                <div className="text-sm text-gray-500">{c.category}</div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>